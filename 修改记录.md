# 修改记录

## 2023-06-15
- 初始版本发布

## 2023-07-10
- 添加了用户自定义单词支持
- 优化了界面响应速度
- 修复了多个已知bug

## 2023-08-22
- 添加了故事主题模板功能
- 优化了后台管理系统

## 2023-09-30
- 增加了填空测试模式
- 添加了更多预设词库

## 2023-11-15
- 添加了单词发音功能
- 优化了移动端显示效果

## 2024-04-30
- 修复后台管理系统中词库分类和单词数据加载不出来的问题
  - 问题原因：数据库中缺少必要的表结构（categories、words、theme_templates表）
  - 解决方法：修改数据库初始化代码，确保创建所有必要的表
  - 优化服务器启动流程，确保在数据库初始化完成后再启动服务器
  - 在admin.html中正确引入admin.js文件
  - 修复API路由问题，确保API请求能正确返回JSON数据而不是HTML页面 

## 2025-07-27

### 后端服务器搭建

1. 创建了 `package.json` 文件，定义了项目依赖：
   - express: Web应用框架
   - sqlite3: SQLite数据库驱动
   - cors: 跨域资源共享
   - morgan: HTTP请求日志记录器
   - nodemon: 开发环境下的自动重启工具

2. 创建了 `server.js` 主服务器文件：
   - 配置了Express应用和中间件
   - 设置了静态文件服务
   - 配置了API路由
   - 实现了服务器启动功能

3. 创建了 `db.js` 数据库连接模块：
   - 实现了与SQLite数据库的连接
   - 封装了SQL查询功能（run, get, all）
   - 实现了数据库初始化和关闭功能

4. 创建了 `routes/api.js` API路由文件：
   - 实现了单词的CRUD操作API
   - 添加了单词搜索功能
   - 统一了错误处理和响应格式

### 使用说明

1. 安装依赖：
   ```
   npm install
   ```

2. 启动服务器：
   ```
   npm start
   ```

3. 开发模式（自动重启）：
   ```
   npm run dev
   ```

4. 服务器默认在 http://localhost:3000 运行 

## 2023-11-17

### CSS和JavaScript代码分离

将原来index.html中的内联CSS和JavaScript代码分离到独立文件中：

1. 创建了 `public/css/styles.css` 文件，包含所有样式定义
2. 创建了 `public/js/main.js` 文件，包含所有JavaScript代码
3. 修改 `public/index.html`，删除内联代码，改为引用外部文件

这样的修改有以下好处：
- 提高代码的可维护性，便于分别管理HTML、CSS和JavaScript
- 提高页面加载性能，支持浏览器缓存外部资源
- 便于团队协作开发，不同开发人员可以专注于不同部分的代码 

## 2023-11-21

### 后台管理系统API修复

修复了admin.html页面中单词数量获取和故事主题模板加载失败的问题：

1. 在`api.js`中添加了缺少的API端点：
   - `/api/health` - 健康检查接口
   - `/api/admin/theme-templates` - 管理员获取所有故事主题模板
   - `/api/admin/theme-templates/:id` - 获取单个故事主题模板详情
   - `/api/words/:categoryId/page/:page` - 分页获取分类单词数据
   - 添加了其他管理功能所需的API接口（批量删除、清理重复单词、清空分类单词等）

2. 修复了API参数和响应格式：
   - 更新了单词相关接口，匹配数据库字段名称（en, phonetic, pos, cn, category_id）
   - 完善了错误处理和响应格式

这些修改使后台管理系统能够正常显示单词数量和故事主题模板数据，解决了仪表盘上的"加载失败"问题。 

### 前端页面动态数据加载

修改了前端页面，实现从数据库动态加载词汇分类和故事主题：

1. 修改了`public/js/main.js`文件：
   - 删除了硬编码的词汇分类和故事主题数据
   - 添加了`loadDataFromAPI()`函数，在页面加载时从API获取数据
   - 更新了UI控件生成逻辑，以适应动态数据
   - 优化了单词获取和故事生成逻辑

2. 实现的功能改进：
   - 词汇分类现在直接从数据库加载，管理员可以在后台添加或修改
   - 故事主题也从数据库加载，可以通过后台进行管理
   - 改进了错误处理，当API加载失败时会显示友好的错误信息

这些修改使前端页面更加灵活，可以轻松适应后台数据的变化，无需修改代码即可添加新的词汇分类或故事主题。 

## 2023-11-28

### 添加AI模型选择功能

增加了在前端页面选择AI模型的功能，可以在生成故事时选择不同的AI模型：

1. 修改了 `public/index.html` 文件：
   - 在参数设置部分下方添加了"选择AI模型"选项
   - 默认选择阿里云千问模型，同时支持选择Google Gemini模型

2. 修改了 `public/js/main.js` 文件：
   - 重构了AI调用相关函数，支持根据用户选择调用不同的API
   - 添加了新函数 `callAIModel` 作为统一入口，根据模型类型分发请求
   - 添加了 `callQwen` 函数用于调用阿里云千问API

3. 添加了新的后端API接口：
   - 在 `routes/api.js` 中添加了 `/api/generate` 接口
   - 实现了根据请求中的 `model` 参数选择调用不同的AI模型API
   - 集成了阿里云千问API，使用环境变量或数据库中存储的API密钥

4. 安装了新的依赖：
   - 添加了 `axios` 库用于服务器端发起HTTP请求调用AI API

这些修改使系统能够灵活选择不同的AI模型来生成故事和学习内容，默认使用阿里云千问模型。

## 2023-12-02

### 优化故事字数范围与单词数量计算

修改了前端页面的故事字数控制和单词数量计算逻辑：

1. 更新了 `public/index.html` 文件：
   - 将故事字数范围从 50-400 字调整为 500-3000 字
   - 设置步进值为 50，使滑块每次调整增减 50 个字
   - 更新了默认字数为 500 字
   - 调整了左右面板的宽度比例为 6:6，优化页面布局

2. 修改了 `public/js/main.js` 文件：
   - 更新了 `updateMaxWordCount` 函数的算法，保持每 50 字可以使用 1 个单词的比例
   - 设置了最小单词数量为 6 个，确保即使在最小字数下也有足够的单词

这些修改提高了生成内容的可控性，让用户可以更精确地控制故事长度和单词数量，有助于生成更适合学习需求的内容。

## 2023-12-05

### 添加浮动生成按钮和修复API调用失败问题

改进了用户界面和解决了生成故事失败的问题：

1. 添加了浮动生成按钮：
   - 在 `public/index.html` 中添加了一个固定位置的浮动按钮
   - 当用户滚动页面时，按钮始终可见，方便随时生成内容
   - 设置了响应式显示，在大屏幕上自动隐藏，避免与主按钮重复
   - 添加了平滑过渡效果，提升用户体验

2. 修复了API调用失败问题：
   - 在 `routes/api.js` 中增强了 `/api/generate` 接口的错误处理
   - 添加了详细的日志记录，帮助追踪API调用过程
   - 改进了阿里云千问API的调用方式，设置了合理的超时时间
   - 针对API错误提供了更详细的反馈信息

3. 优化了用户体验：
   - 调整了故事字数范围为 500-2000 字，更符合实际需求
   - 生成内容后自动滚动到结果区域，便于用户查看
   - 错误信息显示更加详细，帮助用户理解和解决问题

这些修改使系统更加稳定可靠，提升了用户界面的易用性，特别是在移动设备上的操作体验。

## 2023-12-07

### 修复数据库错误和生成按钮悬浮问题

解决了生成故事失败和按钮显示问题：

1. 修复了数据库缺少settings表的问题：
   - 在 `db.js` 中添加了 `initTables` 函数，确保所有必要的表都被创建
   - 实现了自动创建settings表的功能，解决了"no such table: settings"错误
   - 添加了默认的阿里云千问API密钥设置，确保系统初始化后可以正常工作

2. 改进了生成按钮的显示方式：
   - 将原来的浮动按钮替换为主生成按钮的sticky定位
   - 添加了平滑滚动和阴影效果，提升用户体验
   - 保持按钮在滚动过程中始终可见，方便用户操作
   - 保留了字数范围下限200字的设置（根据用户需求）

3. 清理了代码：
   - 移除了不必要的浮动按钮代码和引用
   - 精简了相关的JavaScript功能
   - 统一了按钮样式和行为

这些修改解决了系统的稳定性问题，特别是修复了由于数据库表结构不完整导致的API调用失败，同时改进了用户界面，使生成按钮更加符合用户的操作习惯。 

## 2023-07-27
- 添加了欢迎区域和使用示例
  - 在首页右侧增加欢迎提示和使用说明
  - 添加了视觉化的步骤指南
  - 增加了带有单词高亮的示例内容
  - 修改生成按钮点击逻辑，点击后隐藏欢迎区域

- 优化欢迎区域和示例内容
  - 移除了重复的使用说明部分，保留更简洁的欢迎界面
  - 为示例内容区域的标签添加了切换功能
  - 添加了四种不同类型的示例内容：爽文带背、中英对照、单词列表、填空测试
  - 确保示例区域的样式与实际生成内容保持一致 
  
## 2025-07-28

### 修复功能问题和优化用户体验

1. 修复下载图片功能：
   - 解决了点击"下载图片"按钮后下载空白图片的问题
   - 优化了图片渲染逻辑，确保内容完全加载后再生成图片
   - 增加了渲染延迟时间，从200ms提高到500ms，确保样式充分应用
   - 调整了临时渲染容器的位置和可见性属性，避免影响页面布局

2. 增强单词发音功能：
   - 修复了点击单词无法发音的问题
   - 增加了Web Speech API的错误处理和回退机制
   - 添加了备用发音功能，使用在线字典API获取单词发音
   - 实现了用户友好的反馈机制，当发音失败时显示提示信息

3. 优化字数与单词数量比例：
   - 调整了字数与单词数量的比例关系，从50字/1单词改为30字/1单词
   - 实现了新的线性关系：300字可显示10个单词，600字可显示20个单词
   - 设置最大单词数量上限为50个（对应1500字）
   - 将默认单词数量从10个调整为15个，更符合默认500字的比例
   - 调整了最小单词数量为5个，确保即使在最小字数下也有足够的单词

这些修改提高了系统的稳定性和用户体验，特别是改进了核心功能（下载图片、单词发音）的可靠性，同时优化了字数与单词数量的关系，使生成的内容更加合理和有效。 

## 2025-07-29

### 修复页面数据加载问题

1. 修复了页面无法正确加载数据库数据的问题：
   - 增强了loadDataFromAPI函数，添加了详细的日志记录和错误处理
   - 修复了loadRandomWordsForCategory函数，确保能够正确处理API返回的数据
   - 改进了setupControls函数，添加了对空数据的处理和错误提示
   - 优化了getRandomWords函数，增加了输入验证和异常处理

2. 改进了页面初始化流程：
   - 重构了DOMContentLoaded事件处理函数，使用async/await处理异步操作
   - 添加了更详细的初始化步骤日志，便于调试和问题定位
   - 实现了更友好的错误提示，当初始化失败时向用户显示明确的错误信息
   - 优化了标签页和示例标签页的初始化逻辑，增加了错误处理

3. 增强了用户界面的健壮性：
   - 添加了当数据加载失败时的友好提示
   - 实现了在没有可用词汇分类或故事主题时的提示信息
   - 改进了按钮点击事件的错误处理，防止因异常导致界面卡死
   - 优化了随机单词选择逻辑，确保在各种情况下都能正确处理

这些修改大大提高了系统的稳定性和可靠性，特别是在数据加载和初始化阶段，确保用户能够看到正确的词汇分类和故事主题，并能够顺利使用系统的所有功能。 

## 2024年7月10日
- 修复了CSV文件导入功能
  - 安装了multer模块用于处理文件上传
  - 在routes/api.js中完善了/import-csv接口，添加了文件上传、CSV解析和导入数据库的功能
  - 增强了CSV格式识别功能，支持多种格式：
    1. 考研词汇格式: `单词,/音标/,词性.中文释义`
    2. 高中词汇格式: `单词,/音标/,词性.中文释义`
    3. 六级词汇格式: `单词,音标,词性.中文释义`（音标无斜杠）
    4. 四级词汇格式: `单词,音标,词性.中文释义`（音标无斜杠）
    5. 小学词汇格式: `单词,[ 音标 ],中文释义`（有些无词性）
    6. 雅思词汇格式: `单词,词性.中文释义`（无音标）
    7. 托福词汇格式: `单词,[音标],词性.中文释义`
  - 使用正则表达式智能识别音标列，支持多种音标标记方式：[音标]、/音标/、(音标)
  - 自动从中文释义中提取音标（当音标嵌入中文释义中时）
  - 自动从中文释义中提取词性，支持更多种类的词性标记，如"n."、"v."、"adj."、"adv."、"a."等
  - 修复了前端CSV文件上传表单的问题：
    1. 防止表单提交时页面刷新导致已选择的文件被清空
    2. 在上传过程中禁用提交按钮，防止重复提交
    3. 提交后不再清空文件输入框，以便用户看到已选择的文件
    4. 增强了错误处理和状态反馈
  - 进一步修复CSV导入表单的问题：
    1. 添加了表单的`enctype="multipart/form-data"`属性，这是正确处理文件上传所必需的
    2. 添加了表单的`method="post"`和`action`属性
    3. 修正了表单字段的`name`属性，使其与后端API期望的参数名匹配
    4. 添加了隐藏字段用于标记是否为新分类
    5. 改进了表单提交逻辑，使用FormData直接提交整个表单 