<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爽文带背单词 - 后台管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .sidebar-item.active {
            background-color: rgba(59, 130, 246, 0.1);
            border-left: 3px solid #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="flex h-screen">
        <!-- 侧边栏 -->
        <div class="w-64 bg-white shadow-md">
            <div class="p-4 border-b">
                <h1 class="text-xl font-bold text-gray-800">爽文带背单词</h1>
                <p class="text-sm text-gray-600">后台管理系统</p>
            </div>
            <nav class="mt-4">
                <div class="px-4 py-2 text-xs font-semibold text-gray-500">主菜单</div>
                <a href="#dashboard" class="sidebar-item flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50 active">
                    <i class="fas fa-tachometer-alt w-5 mr-2"></i>
                    <span>仪表盘</span>
                </a>
                
                <div class="px-4 py-2 text-xs font-semibold text-gray-500 mt-4">数据管理</div>
                <a href="#word-data" class="sidebar-item flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50">
                    <i class="fas fa-book w-5 mr-2"></i>
                    <span>单词数据</span>
                </a>
                <a href="#theme-templates" class="sidebar-item flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50">
                    <i class="fas fa-file-alt w-5 mr-2"></i>
                    <span>故事主题模板</span>
                </a>
                
                <div class="px-4 py-2 text-xs font-semibold text-gray-500 mt-4">系统</div>
                <a href="#import-data" class="sidebar-item flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50">
                    <i class="fas fa-file-import w-5 mr-2"></i>
                    <span>数据导入</span>
                </a>
                <a href="#settings" class="sidebar-item flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50">
                    <i class="fas fa-cog w-5 mr-2"></i>
                    <span>系统设置</span>
                </a>
                <a href="/" target="_blank" class="sidebar-item flex items-center px-4 py-3 text-gray-700 hover:bg-blue-50">
                    <i class="fas fa-external-link-alt w-5 mr-2"></i>
                    <span>访问前台</span>
                </a>
            </nav>
        </div>

        <!-- 主内容区 -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- 顶部导航栏 -->
            <header class="bg-white shadow-sm">
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center">
                        <button id="sidebar-toggle" class="mr-4 text-gray-600 focus:outline-none lg:hidden">
                            <i class="fas fa-bars"></i>
                        </button>
                        <h2 id="current-section-title" class="text-lg font-medium">仪表盘</h2>
                    </div>
                    <div class="flex items-center">
                        <span class="text-sm text-gray-600 mr-4">管理员</span>
                        <button class="text-gray-600 hover:text-gray-800 focus:outline-none">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </header>

            <!-- 内容区 -->
            <main class="flex-1 overflow-y-auto p-4 bg-gray-100">
                <!-- 仪表盘内容 -->
                <div id="dashboard-content" class="tab-content active">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                    <i class="fas fa-book text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">单词总数</p>
                                    <p class="text-lg font-semibold" id="total-words-count">加载中...</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-green-100 text-green-600">
                                    <i class="fas fa-layer-group text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">词库分类数</p>
                                    <p class="text-lg font-semibold" id="total-categories-count">加载中...</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4">
                            <div class="flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                    <i class="fas fa-file-alt text-xl"></i>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm text-gray-500">故事主题模板数</p>
                                    <p class="text-lg font-semibold" id="total-templates-count">加载中...</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4">系统信息</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-500 mb-1">系统版本</p>
                                <p class="font-medium">爽文带背单词 v1.0</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 mb-1">最近更新</p>
                                <p class="font-medium" id="last-update-time">2023-06-15</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 mb-1">API状态</p>
                                <p class="font-medium" id="api-status">检查中...</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-500 mb-1">数据库状态</p>
                                <p class="font-medium" id="db-status">检查中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 单词数据管理内容 -->
                <div id="word-data-content" class="tab-content">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <div class="flex justify-between mb-5">
                            <h2 class="text-xl font-semibold">词库分类管理</h2>
                            <button id="add-category-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">
                                <i class="fas fa-plus mr-1"></i> 添加新分类
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">ID</th>
                                        <th class="py-2 px-4 border-b text-left">名称</th>
                                        <th class="py-2 px-4 border-b text-left">描述</th>
                                        <th class="py-2 px-4 border-b text-left">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="categories-table-body">
                                    <!-- 分类数据将在这里动态加载 -->
                                    <tr>
                                        <td colspan="4" class="py-4 text-center text-gray-500">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between mb-5">
                            <h2 class="text-xl font-semibold">单词管理</h2>
                            <div class="flex space-x-2">
                                <select id="category-filter" class="border rounded px-2 py-1">
                                    <option value="">选择词库分类...</option>
                                    <!-- 分类选项将在这里动态加载 -->
                                </select>
                                <div id="category-buttons" class="hidden flex flex-wrap gap-1 mr-2">
                                    <!-- 分类按钮将在这里动态加载 -->
                                </div>
                                <select id="page-size-select" class="border rounded px-2 py-1 hidden">
                                    <option value="50">50条/页</option>
                                    <option value="100" selected>100条/页</option>
                                    <option value="200">200条/页</option>
                                    <option value="500">500条/页</option>
                                </select>
                                <button id="clean-duplicates-btn" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded text-sm hidden">
                                    <i class="fas fa-broom mr-1"></i> 清理重复单词
                                </button>
                                <button id="clear-category-btn" class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded text-sm hidden">
                                    <i class="fas fa-trash-alt mr-1"></i> 清空分类单词
                                </button>
                                <button id="batch-delete-btn" class="bg-orange-500 hover:bg-orange-700 text-white font-bold py-1 px-3 rounded text-sm hidden">
                                    <i class="fas fa-trash mr-1"></i> 批量删除
                                </button>
                                <button id="import-words-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm hidden">
                                    <i class="fas fa-file-import mr-1"></i> 导入单词
                                </button>
                                <button id="add-word-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i> 添加新单词
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">
                                            <input type="checkbox" id="select-all-words" class="batch-delete-checkbox hidden">
                                        </th>
                                        <th class="py-2 px-4 border-b text-left">英文</th>
                                        <th class="py-2 px-4 border-b text-left">音标</th>
                                        <th class="py-2 px-4 border-b text-left">词性</th>
                                        <th class="py-2 px-4 border-b text-left">中文释义</th>
                                        <th class="py-2 px-4 border-b text-left">所属分类</th>
                                        <th class="py-2 px-4 border-b text-left">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="words-table-body">
                                    <!-- 单词数据将在这里动态加载 -->
                                    <tr>
                                        <td colspan="7" class="py-4 text-center text-gray-500">请选择一个词库分类</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 分页控件 -->
                        <div id="pagination-controls" class="mt-4 flex justify-between items-center hidden">
                            <div class="text-sm text-gray-600">
                                共 <span id="total-words">0</span> 个单词，当前显示第 <span id="current-page">1</span>/<span id="total-pages">1</span> 页
                            </div>
                            <div class="flex space-x-2">
                                <button id="first-page-btn" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">首页</button>
                                <button id="prev-page-btn" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">上一页</button>
                                <div class="flex items-center px-2">
                                    <span>跳转到</span>
                                    <input id="page-input" type="number" min="1" class="mx-1 w-16 border rounded px-2 py-1" value="1">
                                    <span>页</span>
                                    <button id="go-page-btn" class="ml-1 px-2 py-1 border rounded bg-blue-500 text-white hover:bg-blue-600">确定</button>
                                </div>
                                <button id="next-page-btn" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">下一页</button>
                                <button id="last-page-btn" class="px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed">末页</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 故事主题模板管理内容 -->
                <div id="theme-templates-content" class="tab-content">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="flex justify-between mb-5">
                            <h2 class="text-xl font-semibold">故事主题模板管理</h2>
                            <div class="flex space-x-2">
                                <button id="import-default-templates-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-1 px-3 rounded text-sm">
                                    <i class="fas fa-download mr-1"></i> 导入默认模板
                                </button>
                                <button id="add-template-btn" class="bg-green-500 hover:bg-green-700 text-white font-bold py-1 px-3 rounded text-sm">
                                    <i class="fas fa-plus mr-1"></i> 添加新模板
                                </button>
                            </div>
                        </div>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full bg-white">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-4 border-b text-left">ID</th>
                                        <th class="py-2 px-4 border-b text-left">名称</th>
                                        <th class="py-2 px-4 border-b text-left">描述</th>
                                        <th class="py-2 px-4 border-b text-left">状态</th>
                                        <th class="py-2 px-4 border-b text-left">操作</th>
                                    </tr>
                                </thead>
                                <tbody id="templates-table-body">
                                    <!-- 模板数据将在这里动态加载 -->
                                    <tr>
                                        <td colspan="5" class="py-4 text-center text-gray-500">加载中...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 数据导入内容 -->
                <div id="import-data-content" class="tab-content">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-5">数据导入</h2>
                        <p class="text-gray-600 mb-3">点击下面的按钮，将从 `public/js/data/wordLists.js` 文件中导入所有预设词库到数据库。如果数据库中已存在，则会更新。</p>
                        <button id="import-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            导入/更新词库数据
                        </button>
                        <div id="import-status" class="mt-3 text-sm"></div>
                        
                        <hr class="my-6 border-t border-gray-300">
                        
                        <h3 class="text-lg font-semibold mb-3">CSV文件导入</h3>
                        <p class="text-gray-600 mb-3">直接上传CSV文件导入大量词汇。CSV文件需包含以下列：英文单词,音标,中文释义（包含词性）</p>
                        <p class="text-gray-600 mb-3">系统会自动从中文释义中提取词性信息，例如："n. 能力 本领"中的"n."会被识别为名词词性</p>
                        <form id="csv-upload-form" class="mb-4">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="category-select">
                                    选择或创建词库分类
                                </label>
                                <div class="flex space-x-2">
                                    <select id="category-select" class="border rounded px-2 py-1 w-1/2">
                                        <option value="">选择现有词库...</option>
                                        <!-- 分类选项将在这里动态加载 -->
                                    </select>
                                    <span class="text-gray-600 flex items-center">或</span>
                                    <input id="new-category-id" class="border rounded px-2 py-1 w-1/4" placeholder="新分类ID" />
                                    <input id="new-category-name" class="border rounded px-2 py-1 w-1/4" placeholder="新分类名称" />
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2" for="csv-file">
                                    选择CSV文件
                                </label>
                                <input type="file" id="csv-file" name="csv-file" accept=".csv" class="w-full" />
                            </div>
                            <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
                                上传并导入
                            </button>
                        </form>
                        <div id="csv-import-status" class="text-sm"></div>
                    </div>
                </div>

                <!-- 系统设置内容 -->
                <div id="settings-content" class="tab-content">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h2 class="text-xl font-semibold mb-5">系统设置</h2>
                        <p class="text-gray-600 mb-6">配置系统参数和API密钥</p>
                        
                        <div class="mb-6">
                            <h3 class="text-lg font-medium mb-3">API密钥配置</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2" for="gemini-api-key">
                                        Google Gemini API密钥
                                    </label>
                                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="gemini-api-key" type="password" placeholder="输入Gemini API密钥">
                                </div>
                                <div>
                                    <label class="block text-gray-700 text-sm font-bold mb-2" for="qwen-api-key">
                                        阿里云千问API密钥
                                    </label>
                                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="qwen-api-key" type="password" placeholder="输入千问API密钥">
                                </div>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">注意：API密钥配置需要重启服务器才能生效</p>
                        </div>
                        
                        <div class="flex justify-end">
                            <button id="save-settings-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                                保存设置
                            </button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- 添加分类模态框 -->
    <div id="category-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">添加新分类</h3>
            <form id="category-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="category-id">
                        分类ID (英文标识符)
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="category-id" type="text" placeholder="例如: cet6">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="category-name">
                        分类名称
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="category-name" type="text" placeholder="例如: 大学六级核心词汇">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="category-description">
                        分类描述
                    </label>
                    <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="category-description" placeholder="例如: 大学英语六级考试常见核心词汇"></textarea>
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                        保存
                    </button>
                    <button class="cancel-btn bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 添加单词模态框 -->
    <div id="word-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">添加新单词</h3>
            <form id="word-form">
                <input type="hidden" id="word-id">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="word-en">
                        英文单词
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="word-en" type="text" placeholder="例如: abandon">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="word-phonetic">
                        音标
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="word-phonetic" type="text" placeholder="例如: /əˈbændən/">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="word-pos">
                        词性
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="word-pos" type="text" placeholder="例如: v.">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="word-cn">
                        中文释义
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="word-cn" type="text" placeholder="例如: 放弃；遗弃">
                </div>
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="word-category">
                        所属分类
                    </label>
                    <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="word-category">
                        <option value="">选择词库分类...</option>
                        <!-- 分类选项将在这里动态加载 -->
                    </select>
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                        保存
                    </button>
                    <button class="cancel-btn bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 导入单词模态框 -->
    <div id="import-words-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md">
            <h3 class="text-lg font-semibold mb-4">导入单词</h3>
            <form id="import-words-form">
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="import-category">
                        导入到分类
                    </label>
                    <select class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="import-category" disabled>
                        <option value="">当前选中的分类</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-1">单词将导入到当前选中的分类中</p>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="import-method">
                        导入方式
                    </label>
                    <div class="flex">
                        <label class="mr-4">
                            <input type="radio" name="import-method" value="csv" checked> CSV文件
                        </label>
                        <label>
                            <input type="radio" name="import-method" value="text"> 文本框
                        </label>
                    </div>
                </div>
                <div id="csv-import-section" class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="import-csv-file">
                        选择CSV文件
                    </label>
                    <input type="file" id="import-csv-file" name="csv-file" accept=".csv" class="w-full">
                    <p class="text-sm text-gray-500 mt-1">CSV格式：英文单词,音标,中文释义（包含词性）</p>
                </div>
                <div id="text-import-section" class="mb-4 hidden">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="import-text">
                        输入单词数据
                    </label>
                    <textarea id="import-text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-40" placeholder="每行一个单词，格式：英文单词,音标,中文释义（包含词性）"></textarea>
                    <p class="text-sm text-gray-500 mt-1">例如：abandon,/əˈbændən/,v. 放弃；遗弃</p>
                </div>
                <div class="flex items-center justify-between">
                    <button id="import-submit-btn" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                        开始导入
                    </button>
                    <button class="cancel-btn bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                        取消
                    </button>
                </div>
                <div id="import-status" class="mt-3 text-sm"></div>
            </form>
        </div>
    </div>

    <!-- 添加主题模板模态框 -->
    <div id="template-modal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-2xl">
            <h3 class="text-lg font-semibold mb-4">添加/编辑故事主题模板</h3>
            <form id="template-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="template-id">
                            模板ID (英文标识符)
                        </label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="template-id" type="text" placeholder="例如: scifi">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2" for="template-name">
                            模板名称
                        </label>
                        <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="template-name" type="text" placeholder="例如: 科幻废土">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="template-description">
                        模板描述
                    </label>
                    <input class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" id="template-description" type="text" placeholder="例如: 末世废土或星际文明世界的科幻故事">
                </div>
                <div class="mb-4">
                    <label class="block text-gray-700 text-sm font-bold mb-2" for="template-prompt">
                        提示词文本
                    </label>
                    <textarea class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline h-40" id="template-prompt" placeholder="输入完整的提示词文本..."></textarea>
                </div>
                <div class="mb-4">
                    <label class="flex items-center">
                        <input type="checkbox" id="template-active" class="mr-2" checked>
                        <span class="text-sm font-medium text-gray-700">启用该模板</span>
                    </label>
                </div>
                <div class="flex items-center justify-between">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="submit">
                        保存
                    </button>
                    <button class="cancel-template-btn bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" type="button">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 基础功能初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 侧边栏导航切换
            const sidebarItems = document.querySelectorAll('.sidebar-item');
            sidebarItems.forEach(item => {
                item.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // 更新活动状态
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    
                    // 获取目标内容区ID
                    const targetId = item.getAttribute('href').substring(1);
                    const sectionTitle = item.querySelector('span').textContent;
                    
                    // 更新标题
                    document.getElementById('current-section-title').textContent = sectionTitle;
                    
                    // 切换内容区显示
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    const targetContent = document.getElementById(`${targetId}-content`);
                    if (targetContent) {
                        targetContent.classList.add('active');
                        
                        // 如果切换到模板管理页面，加载模板数据
                        if (targetId === 'theme-templates') {
                            loadTemplates();
                        }
                        // 如果切换到单词数据页面，加载分类数据
                        else if (targetId === 'word-data') {
                            loadCategories();
                        }
                        // 如果切换到数据导入页面，也加载分类数据
                        else if (targetId === 'import-data') {
                            loadCategoriesForImport();
                        }
                    }
                });
            });
            
            // 加载仪表盘数据
            loadDashboardData();
            
            // 绑定模板管理相关事件
            initTemplateEvents();
            
            // 绑定单词管理相关事件
            initWordEvents();
            
            // 绑定数据导入相关事件
            initImportEvents();
        });
        
        // 加载仪表盘数据
        async function loadDashboardData() {
            try {
                // 检查API状态
                try {
                    const apiResponse = await fetch('/api/health');
                    if (apiResponse.ok) {
                        document.getElementById('api-status').textContent = '正常';
                        document.getElementById('api-status').classList.add('text-green-600');
                    } else {
                        document.getElementById('api-status').textContent = '异常';
                        document.getElementById('api-status').classList.add('text-red-600');
                    }
                } catch (error) {
                    console.error('API状态检查失败:', error);
                    document.getElementById('api-status').textContent = '异常';
                    document.getElementById('api-status').classList.add('text-red-600');
                }
                
                // 加载分类数据
                try {
                    const categoriesResponse = await fetch('/api/words/categories');
                    if (categoriesResponse.ok) {
                        const categories = await categoriesResponse.json();
                        document.getElementById('total-categories-count').textContent = categories.length;
                        document.getElementById('db-status').textContent = '正常';
                        document.getElementById('db-status').classList.add('text-green-600');
                        
                        // 计算所有分类中的单词总数
                        let totalWords = 0;
                        const promises = categories.map(async (category) => {
                            try {
                                const wordsResponse = await fetch(`/api/words/${category.id}/page/1?pageSize=1`);
                                if (wordsResponse.ok) {
                                    const data = await wordsResponse.json();
                                    return data.pagination.total;
                                }
                                return 0;
                            } catch (error) {
                                console.error(`获取分类 ${category.id} 的单词数量失败:`, error);
                                return 0;
                            }
                        });
                        
                        const counts = await Promise.all(promises);
                        totalWords = counts.reduce((sum, count) => sum + count, 0);
                        document.getElementById('total-words-count').textContent = totalWords;
                    } else {
                        document.getElementById('total-categories-count').textContent = '加载失败';
                        document.getElementById('db-status').textContent = '异常';
                        document.getElementById('db-status').classList.add('text-red-600');
                    }
                } catch (error) {
                    console.error('加载分类数据失败:', error);
                    document.getElementById('total-categories-count').textContent = '加载失败';
                    document.getElementById('db-status').textContent = '异常';
                    document.getElementById('db-status').classList.add('text-red-600');
                }
                
                // 加载模板数据
                try {
                    const templatesResponse = await fetch('/api/admin/theme-templates');
                    if (templatesResponse.ok) {
                        const templates = await templatesResponse.json();
                        document.getElementById('total-templates-count').textContent = templates.length;
                    } else {
                        document.getElementById('total-templates-count').textContent = '加载失败';
                    }
                } catch (error) {
                    console.error('加载模板数据失败:', error);
                    document.getElementById('total-templates-count').textContent = '加载失败';
                }
                
            } catch (error) {
                console.error('加载仪表盘数据失败:', error);
                document.getElementById('api-status').textContent = '异常';
                document.getElementById('api-status').classList.add('text-red-600');
                document.getElementById('db-status').textContent = '异常';
                document.getElementById('db-status').classList.add('text-red-600');
            }
        }
        
        // 初始化模板管理相关事件
        function initTemplateEvents() {
            // 添加模板按钮点击事件
            document.getElementById('add-template-btn').addEventListener('click', () => {
                // 重置表单
                document.getElementById('template-form').reset();
                document.getElementById('template-id').disabled = false;
                document.getElementById('template-modal').classList.remove('hidden');
            });
            
            // 导入默认模板按钮点击事件
            document.getElementById('import-default-templates-btn').addEventListener('click', importDefaultTemplates);
            
            // 模板表单提交事件
            document.getElementById('template-form').addEventListener('submit', saveTemplate);
            
            // 模板模态框取消按钮点击事件
            document.querySelectorAll('.cancel-template-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('template-modal').classList.add('hidden');
                });
            });
        }
        
        // 加载故事主题模板列表
        async function loadTemplates() {
            try {
                const response = await fetch('/api/admin/theme-templates');
                if (!response.ok) {
                    throw new Error(`加载模板失败: ${response.status}`);
                }
                
                const templates = await response.json();
                const tableBody = document.getElementById('templates-table-body');
                
                // 确保templates是数组
                if (!Array.isArray(templates)) {
                    console.error('加载模板失败: 返回数据不是数组');
                    tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-500">加载失败: 数据格式错误</td></tr>';
                    return;
                }
                
                if (templates.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">暂无数据</td></tr>';
                    return;
                }
                
                let html = '';
                templates.forEach(template => {
                    if (!template || !template.id) return; // 跳过无效数据
                    
                    const status = template.is_active ? 
                        '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">启用</span>' : 
                        '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">禁用</span>';
                    
                    const safeId = template.id.replace(/'/g, "\\'"); // 转义单引号
                    
                    html += `
                        <tr>
                            <td class="py-2 px-4 border-b">${template.id}</td>
                            <td class="py-2 px-4 border-b">${template.name || ''}</td>
                            <td class="py-2 px-4 border-b">${template.description || ''}</td>
                            <td class="py-2 px-4 border-b">${status}</td>
                            <td class="py-2 px-4 border-b">
                                <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="viewTemplate('${safeId}')">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="text-green-500 hover:text-green-700 mr-2" onclick="editTemplate('${safeId}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteTemplate('${safeId}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                tableBody.innerHTML = html;
                
            } catch (error) {
                console.error('加载模板失败:', error);
                document.getElementById('templates-table-body').innerHTML = 
                    '<tr><td colspan="5" class="py-4 text-center text-red-500">加载失败: ' + error.message + '</td></tr>';
            }
        }
        
        // 查看模板详情
        async function viewTemplate(id) {
            try {
                const response = await fetch(`/api/admin/theme-templates/${id}`);
                if (!response.ok) {
                    throw new Error(`获取模板失败: ${response.status}`);
                }
                
                const template = await response.json();
                
                // 填充表单
                document.getElementById('template-id').value = template.id;
                document.getElementById('template-id').disabled = true; // 查看模式下不允许修改ID
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-description').value = template.description || '';
                document.getElementById('template-prompt').value = template.prompt_text;
                document.getElementById('template-active').checked = template.is_active === 1;
                
                // 禁用所有输入框
                document.querySelectorAll('#template-form input, #template-form textarea').forEach(input => {
                    input.disabled = true;
                });
                
                // 隐藏保存按钮，只显示取消按钮
                document.querySelector('#template-form button[type="submit"]').classList.add('hidden');
                
                // 显示模态框
                document.getElementById('template-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('查看模板失败:', error);
                alert('查看模板失败: ' + error.message);
            }
        }
        
        // 编辑模板
        async function editTemplate(id) {
            try {
                const response = await fetch(`/api/admin/theme-templates/${id}`);
                if (!response.ok) {
                    throw new Error(`获取模板失败: ${response.status}`);
                }
                
                const template = await response.json();
                
                // 填充表单
                document.getElementById('template-id').value = template.id;
                document.getElementById('template-id').disabled = true; // 编辑模式下不允许修改ID
                document.getElementById('template-name').value = template.name;
                document.getElementById('template-description').value = template.description || '';
                document.getElementById('template-prompt').value = template.prompt_text;
                document.getElementById('template-active').checked = template.is_active === 1;
                
                // 启用所有输入框
                document.querySelectorAll('#template-form input, #template-form textarea').forEach(input => {
                    input.disabled = false;
                });
                
                // 显示保存按钮
                document.querySelector('#template-form button[type="submit"]').classList.remove('hidden');
                
                // 显示模态框
                document.getElementById('template-modal').classList.remove('hidden');
                
            } catch (error) {
                console.error('编辑模板失败:', error);
                alert('编辑模板失败: ' + error.message);
            }
        }
        
        // 保存模板
        async function saveTemplate(e) {
            e.preventDefault();
            
            const id = document.getElementById('template-id').value.trim();
            const name = document.getElementById('template-name').value.trim();
            const description = document.getElementById('template-description').value.trim();
            const prompt_text = document.getElementById('template-prompt').value.trim();
            const is_active = document.getElementById('template-active').checked ? 1 : 0;
            
            if (!id || !name || !prompt_text) {
                alert('ID、名称和提示词文本为必填项');
                return;
            }
            
            const templateData = { id, name, description, prompt_text, is_active };
            const isEdit = document.getElementById('template-id').disabled;
            
            try {
                const url = isEdit ? `/api/admin/theme-templates/${id}` : '/api/admin/theme-templates';
                const method = isEdit ? 'PUT' : 'POST';
                
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `保存失败: ${response.status}`);
                }
                
                // 关闭模态框
                document.getElementById('template-modal').classList.add('hidden');
                
                // 重新加载模板列表
                loadTemplates();
                
                // 更新仪表盘数据
                loadDashboardData();
                
            } catch (error) {
                console.error('保存模板失败:', error);
                alert('保存模板失败: ' + error.message);
            }
        }
        
        // 删除模板
        async function deleteTemplate(id) {
            if (!confirm(`确定要删除模板 "${id}" 吗？`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/theme-templates/${id}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `删除失败: ${response.status}`);
                }
                
                // 重新加载模板列表
                loadTemplates();
                
                // 更新仪表盘数据
                loadDashboardData();
                
            } catch (error) {
                console.error('删除模板失败:', error);
                alert('删除模板失败: ' + error.message);
            }
        }
        
        // 导入默认模板
        async function importDefaultTemplates() {
            if (!confirm('确定要导入默认的故事主题模板吗？这将覆盖同名的现有模板。')) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/import-default-templates', {
                    method: 'POST'
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `导入失败: ${response.status}`);
                }
                
                const result = await response.json();
                alert(`成功导入 ${result.count} 个默认模板`);
                
                // 重新加载模板列表
                loadTemplates();
                
                // 更新仪表盘数据
                loadDashboardData();
                
            } catch (error) {
                console.error('导入默认模板失败:', error);
                alert('导入默认模板失败: ' + error.message);
            }
        }
        
        // 初始化单词管理相关事件
        function initWordEvents() {
            // 全局变量
            window.categories = window.categories || [];
            window.currentEditId = null;
            window.currentPage = 1;
            window.totalPages = 1;
            window.currentCategoryId = '';
            window.pageSize = 100; // 默认每页100条
            
            // 添加分类按钮点击事件
            document.getElementById('add-category-btn').addEventListener('click', () => {
                // 重置表单
                document.getElementById('category-form').reset();
                document.getElementById('category-modal').classList.remove('hidden');
            });
            
            // 添加单词按钮点击事件
            document.getElementById('add-word-btn').addEventListener('click', () => {
                // 重置表单
                document.getElementById('word-form').reset();
                document.getElementById('word-modal').classList.remove('hidden');
            });
            
            // 导入单词按钮点击事件
            document.getElementById('import-words-btn').addEventListener('click', () => {
                // 设置导入分类信息
                const categoryId = document.getElementById('category-filter').value;
                const categoryName = getCategoryName(categoryId);
                document.getElementById('import-category').innerHTML = `<option value="${categoryId}">${categoryName}</option>`;
                
                // 显示模态框
                document.getElementById('import-words-modal').classList.remove('hidden');
            });
            
            // 绑定清理重复单词按钮事件
            document.getElementById('clean-duplicates-btn').addEventListener('click', cleanDuplicateWords);
            
            // 绑定清空分类单词按钮事件
            document.getElementById('clear-category-btn').addEventListener('click', clearCategoryWords);
            
            // 绑定批量删除按钮事件
            document.getElementById('batch-delete-btn').addEventListener('click', batchDeleteWords);
            
            // 绑定分类筛选器变更事件
            document.getElementById('category-filter').addEventListener('change', (e) => {
                const categoryId = e.target.value;
                currentCategoryId = categoryId;
                if (categoryId) {
                    // 重置为第一页
                    currentPage = 1;
                    document.getElementById('page-input').value = 1;
                    
                    // 加载单词（带分页）
                    loadWordsWithPagination(categoryId, currentPage, pageSize);
                    
                    // 显示相关按钮
                    document.getElementById('clean-duplicates-btn').classList.remove('hidden');
                    document.getElementById('clear-category-btn').classList.remove('hidden');
                    document.getElementById('batch-delete-btn').classList.remove('hidden');
                    document.getElementById('select-all-words').classList.remove('hidden');
                    document.getElementById('page-size-select').classList.remove('hidden');
                    document.getElementById('pagination-controls').classList.remove('hidden');
                    document.getElementById('import-words-btn').classList.remove('hidden');
                } else {
                    document.getElementById('words-table-body').innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">请先选择一个词库分类</td></tr>';
                    
                    // 隐藏相关按钮
                    document.getElementById('clean-duplicates-btn').classList.add('hidden');
                    document.getElementById('clear-category-btn').classList.add('hidden');
                    document.getElementById('batch-delete-btn').classList.add('hidden');
                    document.getElementById('select-all-words').classList.add('hidden');
                    document.getElementById('page-size-select').classList.add('hidden');
                    document.getElementById('pagination-controls').classList.add('hidden');
                    document.getElementById('import-words-btn').classList.add('hidden');
                }
            });
            
            // 绑定分页控件事件
            document.getElementById('first-page-btn').addEventListener('click', () => goToPage(1));
            document.getElementById('prev-page-btn').addEventListener('click', () => goToPage(currentPage - 1));
            document.getElementById('next-page-btn').addEventListener('click', () => goToPage(currentPage + 1));
            document.getElementById('last-page-btn').addEventListener('click', () => goToPage(totalPages));
            document.getElementById('go-page-btn').addEventListener('click', () => {
                const page = parseInt(document.getElementById('page-input').value);
                if (page >= 1 && page <= totalPages) {
                    goToPage(page);
                } else {
                    alert(`请输入1-${totalPages}之间的页码`);
                }
            });
            
            // 绑定每页显示数量变更事件
            document.getElementById('page-size-select').addEventListener('change', (e) => {
                pageSize = parseInt(e.target.value);
                currentPage = 1; // 重置到第一页
                loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
            });
            
            // 绑定表单提交事件
            document.getElementById('category-form').addEventListener('submit', saveCategory);
            document.getElementById('word-form').addEventListener('submit', saveWord);
            
            // 绑定模态框取消按钮事件
            document.querySelectorAll('.cancel-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.getElementById('category-modal').classList.add('hidden');
                    document.getElementById('word-modal').classList.add('hidden');
                    document.getElementById('import-words-modal').classList.add('hidden');
                });
            });
            
            // 绑定全选/取消全选事件
            document.getElementById('select-all-words').addEventListener('change', toggleAllWords);
            
            // 获取分类名称
            function getCategoryName(categoryId) {
                const category = categories.find(c => c.id === categoryId);
                return category ? category.name : categoryId;
            }
            
            // 跳转到指定页
            function goToPage(page) {
                if (page < 1 || page > totalPages) {
                    return;
                }
                
                currentPage = page;
                document.getElementById('page-input').value = page;
                loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
            }
            
            // 全选/取消全选单词
            function toggleAllWords(e) {
                const isChecked = e.target.checked;
                document.querySelectorAll('.word-checkbox').forEach(checkbox => {
                    checkbox.checked = isChecked;
                });
            }
        }
        
        // 初始化数据导入相关事件
        function initImportEvents() {
            // 绑定导入按钮事件
            document.getElementById('import-btn').addEventListener('click', importData);
            
            // 绑定CSV上传表单提交事件
            document.getElementById('csv-upload-form').addEventListener('submit', uploadCSV);
            
            // 绑定导入方式切换事件
            document.querySelectorAll('input[name="import-method"]').forEach(radio => {
                radio.addEventListener('change', toggleImportMethod);
            });
            
            // 绑定导入提交按钮事件
            document.getElementById('import-submit-btn').addEventListener('click', submitImport);
        }
        
        // 加载分类数据
        async function loadCategories() {
            try {
                const response = await fetch('/api/words/categories');
                if (!response.ok) {
                    throw new Error(`加载分类失败: ${response.status}`);
                }
                
                const categories = await response.json();
                // 确保categories是数组
                if (!Array.isArray(categories)) {
                    console.error('加载分类失败: 返回数据不是数组');
                    document.getElementById('categories-table-body').innerHTML = 
                        '<tr><td colspan="4" class="py-4 text-center text-red-500">加载失败: 数据格式错误</td></tr>';
                    return;
                }
                
                window.categories = categories; // 存储到全局变量
                
                // 更新分类表格
                const tableBody = document.getElementById('categories-table-body');
                if (categories.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">暂无数据</td></tr>';
                    return;
                }
                
                let html = '';
                categories.forEach(category => {
                    if (!category || !category.id) return; // 跳过无效数据
                    
                    const safeId = category.id.replace(/'/g, "\\'"); // 转义单引号
                    html += `
                        <tr>
                            <td class="py-2 px-4 border-b">${category.id}</td>
                            <td class="py-2 px-4 border-b">${category.name || ''}</td>
                            <td class="py-2 px-4 border-b">${category.description || ''}</td>
                            <td class="py-2 px-4 border-b">
                                <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="viewWords('${safeId}')">查看单词</button>
                                <button class="text-green-500 hover:text-green-700 mr-2" onclick="editCategory('${safeId}')">编辑</button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteCategory('${safeId}')">删除</button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
                
                // 更新分类下拉框
                updateCategoryDropdowns(categories);
                
            } catch (error) {
                console.error('加载分类失败:', error);
                document.getElementById('categories-table-body').innerHTML = 
                    '<tr><td colspan="4" class="py-4 text-center text-red-500">加载失败</td></tr>';
            }
        }
        
        // 加载分类数据（用于导入页面）
        async function loadCategoriesForImport() {
            try {
                const response = await fetch('/api/words/categories');
                if (!response.ok) {
                    throw new Error(`加载分类失败: ${response.status}`);
                }
                
                const categories = await response.json();
                
                // 更新分类下拉框
                const categorySelect = document.getElementById('category-select');
                
                // 清空现有选项，但保留第一个
                while (categorySelect.options.length > 1) {
                    categorySelect.remove(1);
                }
                
                // 添加新选项
                categories.forEach(category => {
                    const option = new Option(category.name, category.id);
                    categorySelect.add(option);
                });
                
            } catch (error) {
                console.error('加载分类失败:', error);
            }
        }
        
        // 更新分类下拉框
        function updateCategoryDropdowns(data) {
            if (!Array.isArray(data)) {
                console.error('更新分类下拉框失败: 数据不是数组');
                return;
            }
            
            const categoryFilter = document.getElementById('category-filter');
            const wordCategory = document.getElementById('word-category');
            
            if (!categoryFilter || !wordCategory) {
                console.error('更新分类下拉框失败: 找不到下拉框元素');
                return;
            }
            
            // 清空现有选项，但保留第一个
            while (categoryFilter.options.length > 1) {
                categoryFilter.remove(1);
            }
            
            while (wordCategory.options.length > 1) {
                wordCategory.remove(1);
            }
            
            // 添加新选项
            data.forEach(category => {
                if (!category || !category.id || !category.name) return; // 跳过无效数据
                
                try {
                    const option1 = new Option(category.name, category.id);
                    const option2 = new Option(category.name, category.id);
                    categoryFilter.add(option1);
                    wordCategory.add(option2);
                } catch (error) {
                    console.error(`添加分类选项失败: ${category.id}`, error);
                }
            });
        }
        
        // 加载单词数据（带分页）
        async function loadWordsWithPagination(categoryId, page, pageSize) {
            try {
                if (!categoryId) {
                    console.error('加载单词失败: 分类ID为空');
                    document.getElementById('words-table-body').innerHTML = 
                        '<tr><td colspan="7" class="py-4 text-center text-red-500">加载失败: 分类ID为空</td></tr>';
                    return;
                }
                
                const response = await fetch(`/api/words/${categoryId}/page/${page}?pageSize=${pageSize}`);
                if (!response.ok) {
                    throw new Error(`加载单词失败: ${response.status}`);
                }
                
                const data = await response.json();
                const tableBody = document.getElementById('words-table-body');
                
                // 验证返回的数据格式
                if (!data || !data.pagination || !Array.isArray(data.words)) {
                    throw new Error('返回的数据格式不正确');
                }
                
                // 更新分页信息
                currentPage = data.pagination.currentPage || 1;
                totalPages = data.pagination.totalPages || 1;
                
                document.getElementById('total-words').textContent = data.pagination.total || 0;
                document.getElementById('current-page').textContent = currentPage;
                document.getElementById('total-pages').textContent = totalPages;
                document.getElementById('page-input').value = currentPage;
                
                // 更新分页按钮状态
                document.getElementById('first-page-btn').disabled = currentPage === 1;
                document.getElementById('prev-page-btn').disabled = currentPage === 1;
                document.getElementById('next-page-btn').disabled = currentPage === totalPages;
                document.getElementById('last-page-btn').disabled = currentPage === totalPages;
                
                if (data.words.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">该分类下暂无单词</td></tr>';
                    return;
                }
                
                let html = '';
                data.words.forEach(word => {
                    if (!word || !word.id || !word.en) return; // 跳过无效数据
                    
                    const categoryName = getCategoryName(word.category_id);
                    const wordId = word.id.toString().replace(/"/g, '&quot;'); // 转义引号
                    
                    html += `
                        <tr>
                            <td class="py-2 px-4 border-b">
                                <input type="checkbox" class="word-checkbox batch-delete-checkbox" data-id="${wordId}">
                            </td>
                            <td class="py-2 px-4 border-b">${word.en}</td>
                            <td class="py-2 px-4 border-b">${word.phonetic || ''}</td>
                            <td class="py-2 px-4 border-b">${word.pos || ''}</td>
                            <td class="py-2 px-4 border-b">${word.cn || ''}</td>
                            <td class="py-2 px-4 border-b">${categoryName || ''}</td>
                            <td class="py-2 px-4 border-b">
                                <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editWord(${wordId})">编辑</button>
                                <button class="text-red-500 hover:text-red-700" onclick="deleteWord(${wordId})">删除</button>
                            </td>
                        </tr>
                    `;
                });
                tableBody.innerHTML = html;
                
            } catch (error) {
                console.error('加载单词失败:', error);
                document.getElementById('words-table-body').innerHTML = 
                    '<tr><td colspan="7" class="py-4 text-center text-red-500">加载失败: ' + error.message + '</td></tr>';
            }
        }
        
        // 导入数据
        function importData() {
            const statusDiv = document.getElementById('import-status');
            statusDiv.textContent = '正在导入...';
            statusDiv.className = 'mt-3 text-sm text-gray-700';

            fetch('/api/import', {
                method: 'POST'
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('导入失败!');
            })
            .then(text => {
                statusDiv.textContent = `成功: ${text}`;
                statusDiv.className = 'mt-3 text-sm text-green-700';
                // 重新加载分类数据
                loadCategories();
                // 更新仪表盘数据
                loadDashboardData();
            })
            .catch(error => {
                statusDiv.textContent = `错误: ${error.message}`;
                statusDiv.className = 'mt-3 text-sm text-red-700';
            });
        }
        
        // 切换导入方式
        function toggleImportMethod() {
            const method = document.querySelector('input[name="import-method"]:checked').value;
            
            if (method === 'csv') {
                document.getElementById('csv-import-section').classList.remove('hidden');
                document.getElementById('text-import-section').classList.add('hidden');
            } else {
                document.getElementById('csv-import-section').classList.add('hidden');
                document.getElementById('text-import-section').classList.remove('hidden');
            }
        }
        
        // 上传并导入CSV文件
        function uploadCSV(e) {
            e.preventDefault();
            
            const statusDiv = document.getElementById('csv-import-status');
            const fileInput = document.getElementById('csv-file');
            const categorySelect = document.getElementById('category-select');
            const newCategoryId = document.getElementById('new-category-id');
            const newCategoryName = document.getElementById('new-category-name');
            
            // 检查是否选择了文件
            if (!fileInput.files || fileInput.files.length === 0) {
                statusDiv.textContent = '请选择CSV文件';
                statusDiv.className = 'mt-3 text-sm text-red-700';
                return;
            }
            
            // 检查分类信息
            let categoryId = categorySelect.value;
            let isNewCategory = false;
            
            if (!categoryId) {
                // 检查是否提供了新分类信息
                categoryId = newCategoryId.value.trim();
                const categoryName = newCategoryName.value.trim();
                
                if (!categoryId || !categoryName) {
                    statusDiv.textContent = '请选择现有分类或提供新分类信息';
                    statusDiv.className = 'mt-3 text-sm text-red-700';
                    return;
                }
                
                isNewCategory = true;
            }
            
            // 构建FormData对象
            const formData = new FormData();
            formData.append('csvFile', fileInput.files[0]);
            formData.append('categoryId', categoryId);
            
            if (isNewCategory) {
                formData.append('categoryName', newCategoryName.value.trim());
                formData.append('isNewCategory', 'true');
            }
            
            // 显示上传中状态
            statusDiv.textContent = '正在上传并处理CSV文件，请稍候...';
            statusDiv.className = 'mt-3 text-sm text-gray-700';
            
            // 发送请求
            fetch('/api/import-csv', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Failed to upload CSV');
                    });
                }
                return response.json();
            })
            .then(result => {
                statusDiv.textContent = `成功导入${result.wordCount}个单词到"${result.categoryName}"分类`;
                statusDiv.className = 'mt-3 text-sm text-green-700';
                
                // 重置表单
                fileInput.value = '';
                
                // 如果是新分类，重置输入框
                if (isNewCategory) {
                    newCategoryId.value = '';
                    newCategoryName.value = '';
                }
                
                // 重新加载分类数据
                loadCategories();
                // 更新仪表盘数据
                loadDashboardData();
            })
            .catch(error => {
                statusDiv.textContent = `错误: ${error.message}`;
                statusDiv.className = 'mt-3 text-sm text-red-700';
            });
        }
        
        // 查看分类下的单词
        function viewWords(categoryId) {
            // 切换到单词管理标签
            document.querySelector('.sidebar-item[href="#word-data"]').click();
            
            // 设置分类筛选器
            document.getElementById('category-filter').value = categoryId;
            
            // 触发change事件
            const event = new Event('change');
            document.getElementById('category-filter').dispatchEvent(event);
        }
        
        // 编辑分类
        function editCategory(id) {
            // 查找分类数据
            const category = window.categories.find(c => c.id === id);
            if (!category) {
                alert('找不到该分类');
                return;
            }
            
            // 填充表单
            document.getElementById('category-id').value = category.id;
            document.getElementById('category-name').value = category.name;
            document.getElementById('category-description').value = category.description || '';
            
            // 添加一个隐藏字段来存储原始ID
            let editIdField = document.getElementById('category-edit-id');
            if (!editIdField) {
                editIdField = document.createElement('input');
                editIdField.type = 'hidden';
                editIdField.id = 'category-edit-id';
                document.getElementById('category-form').appendChild(editIdField);
            }
            editIdField.value = id;
            
            // 修改模态框标题
            document.querySelector('#category-modal h3').textContent = '编辑分类';
            
            // 显示模态框
            document.getElementById('category-modal').classList.remove('hidden');
        }
        
        // 保存分类
        function saveCategory(e) {
            e.preventDefault();
            
            const id = document.getElementById('category-id').value.trim();
            const name = document.getElementById('category-name').value.trim();
            const description = document.getElementById('category-description').value.trim();
            const editId = document.getElementById('category-edit-id') ? document.getElementById('category-edit-id').value : null;
            
            if (!id || !name) {
                alert('ID和名称为必填项');
                return;
            }
            
            let url = '/api/words/categories';
            let method = 'POST';
            
            // 如果是编辑模式
            if (editId) {
                url = `/api/words/categories/${editId}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id, name, description })
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || '保存失败');
                    });
                }
                return response.json();
            })
            .then(() => {
                document.getElementById('category-modal').classList.add('hidden');
                loadCategories();
            })
            .catch(error => {
                alert(`错误: ${error.message}`);
            });
        }
        
        // 删除分类
        function deleteCategory(id) {
            if (!confirm(`确定要删除分类 "${id}" 吗？`)) {
                return;
            }
            
            fetch(`/api/words/categories/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || '删除失败');
                    });
                }
                return response.json();
            })
            .then(() => {
                loadCategories();
            })
            .catch(error => {
                alert(`错误: ${error.message}`);
            });
        }
        
        // 编辑单词
        function editWord(id) {
            if (!id) {
                alert('单词ID无效');
                return;
            }
            
            fetch(`/api/words/detail/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`获取单词数据失败: ${response.status}`);
                    }
                    return response.json();
                })
                .then(word => {
                    if (!word || !word.id) {
                        throw new Error('获取到的单词数据无效');
                    }
                    
                    document.getElementById('word-id').value = word.id;
                    document.getElementById('word-en').value = word.en || '';
                    document.getElementById('word-phonetic').value = word.phonetic || '';
                    document.getElementById('word-pos').value = word.pos || '';
                    document.getElementById('word-cn').value = word.cn || '';
                    document.getElementById('word-category').value = word.category_id || '';
                    
                    document.getElementById('word-modal').classList.remove('hidden');
                })
                .catch(error => {
                    console.error('加载单词数据失败:', error);
                    alert('加载单词数据失败: ' + error.message);
                });
        }
        
        // 保存单词
        function saveWord(e) {
            e.preventDefault();
            
            const id = document.getElementById('word-id').value;
            const en = document.getElementById('word-en').value.trim();
            const phonetic = document.getElementById('word-phonetic').value.trim();
            const pos = document.getElementById('word-pos').value.trim();
            const cn = document.getElementById('word-cn').value.trim();
            const category_id = document.getElementById('word-category').value;
            
            if (!en || !category_id) {
                alert('英文单词和所属分类为必填项');
                return;
            }
            
            const wordData = { en, phonetic, pos, cn, category_id };
            
            let url = '/api/words';
            let method = 'POST';
            
            if (id) {
                url = `/api/words/${id}`;
                method = 'PUT';
            }
            
            fetch(url, {
                method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(wordData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `保存失败: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(() => {
                document.getElementById('word-modal').classList.add('hidden');
                const categoryId = document.getElementById('category-filter').value;
                if (categoryId) {
                    loadWordsWithPagination(categoryId, currentPage, pageSize);
                }
            })
            .catch(error => {
                console.error('保存单词失败:', error);
                alert(`错误: ${error.message}`);
            });
        }
        
        // 删除单词
        function deleteWord(id) {
            if (!id) {
                alert('单词ID无效');
                return;
            }
            
            if (!confirm('确定要删除这个单词吗？')) {
                return;
            }
            
            fetch(`/api/words/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `删除失败: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(() => {
                // 重新加载当前页
                const categoryId = document.getElementById('category-filter').value;
                loadWordsWithPagination(categoryId, currentPage, pageSize);
            })
            .catch(error => {
                console.error('删除单词失败:', error);
                alert(`错误: ${error.message}`);
            });
        }
        
        // 清理重复单词
        function cleanDuplicateWords() {
            const categoryId = document.getElementById('category-filter').value;
            
            if (!categoryId) {
                alert('请先选择一个词库分类');
                return;
            }
            
            if (!confirm('确定要清理该分类下的重复单词吗？此操作将保留每个单词的第一个出现，删除其余重复项。')) {
                return;
            }
            
            // 显示加载状态
            const cleanBtn = document.getElementById('clean-duplicates-btn');
            const originalText = cleanBtn.textContent;
            cleanBtn.textContent = '清理中...';
            cleanBtn.disabled = true;
            
            fetch(`/api/words/categories/${categoryId}/clean-duplicates`, {
                method: 'POST'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('清理失败');
                }
                return response.json();
            })
            .then(result => {
                // 恢复按钮状态
                cleanBtn.textContent = originalText;
                cleanBtn.disabled = false;
                
                // 显示结果
                if (result.deletedCount > 0) {
                    alert(`清理完成！已删除 ${result.deletedCount} 个重复单词。`);
                } else {
                    alert('没有找到需要清理的重复单词。');
                }
                
                // 重新加载单词列表
                loadWordsWithPagination(categoryId, currentPage, pageSize);
            })
            .catch(error => {
                // 恢复按钮状态
                cleanBtn.textContent = originalText;
                cleanBtn.disabled = false;
                
                alert(`错误: ${error.message}`);
            });
        }
        
        // 清空分类单词
        function clearCategoryWords() {
            const categoryId = document.getElementById('category-filter').value;
            
            if (!categoryId) {
                alert('请先选择一个词库分类');
                return;
            }
            
            const categoryName = getCategoryName(categoryId);
            if (!confirm(`确定要清空"${categoryName}"分类下的所有单词吗？此操作不可恢复！`)) {
                return;
            }
            
            // 二次确认
            if (!confirm('警告：此操作将永久删除该分类下的所有单词数据，确定要继续吗？')) {
                return;
            }
            
            // 显示加载状态
            const clearBtn = document.getElementById('clear-category-btn');
            const originalText = clearBtn.textContent;
            clearBtn.textContent = '清空中...';
            clearBtn.disabled = true;
            
            fetch(`/api/words/categories/${categoryId}/words`, {
                method: 'DELETE'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('清空失败');
                }
                return response.json();
            })
            .then(result => {
                // 恢复按钮状态
                clearBtn.textContent = originalText;
                clearBtn.disabled = false;
                
                // 显示结果
                alert(`清空成功！已删除 ${result.deletedCount} 个单词。`);
                
                // 重置到第一页并重新加载
                currentPage = 1;
                document.getElementById('page-input').value = 1;
                loadWordsWithPagination(categoryId, currentPage, pageSize);
            })
            .catch(error => {
                // 恢复按钮状态
                clearBtn.textContent = originalText;
                clearBtn.disabled = false;
                
                alert(`错误: ${error.message}`);
            });
        }
        
        // 批量删除单词
        function batchDeleteWords() {
            const selectedIds = [];
            document.querySelectorAll('.word-checkbox:checked').forEach(checkbox => {
                try {
                    // 尝试将ID转换为整数，如果失败则使用原始字符串
                    const id = checkbox.dataset.id;
                    const parsedId = parseInt(id);
                    selectedIds.push(isNaN(parsedId) ? id : parsedId);
                } catch (error) {
                    console.error('解析单词ID失败:', error);
                }
            });
            
            if (selectedIds.length === 0) {
                alert('请先选择要删除的单词');
                return;
            }
            
            if (!confirm(`确定要删除选中的 ${selectedIds.length} 个单词吗？`)) {
                return;
            }
            
            // 显示加载状态
            const batchDeleteBtn = document.getElementById('batch-delete-btn');
            const originalText = batchDeleteBtn.textContent;
            batchDeleteBtn.textContent = '删除中...';
            batchDeleteBtn.disabled = true;
            
            fetch('/api/words/batch-delete', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ids: selectedIds })
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || `批量删除失败: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(result => {
                // 恢复按钮状态
                batchDeleteBtn.textContent = originalText;
                batchDeleteBtn.disabled = false;
                
                // 显示结果
                const deletedCount = result.deletedCount || 0;
                alert(`删除成功！已删除 ${deletedCount} 个单词。`);
                
                // 重新加载当前页
                loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
            })
            .catch(error => {
                // 恢复按钮状态
                batchDeleteBtn.textContent = originalText;
                batchDeleteBtn.disabled = false;
                
                console.error('批量删除单词失败:', error);
                alert(`错误: ${error.message}`);
            });
        }
        
        // 提交导入
        function submitImport() {
            const categoryId = document.getElementById('import-category').value;
            const method = document.querySelector('input[name="import-method"]:checked').value;
            const statusDiv = document.getElementById('import-status');
            
            if (!categoryId) {
                statusDiv.textContent = '请先选择一个分类';
                statusDiv.className = 'mt-3 text-sm text-red-700';
                return;
            }
            
            // 显示加载状态
            const importBtn = document.getElementById('import-submit-btn');
            const originalText = importBtn.textContent;
            importBtn.textContent = '导入中...';
            importBtn.disabled = true;
            statusDiv.textContent = '正在处理...';
            statusDiv.className = 'mt-3 text-sm text-gray-700';
            
            if (method === 'csv') {
                // CSV文件导入
                const fileInput = document.getElementById('import-csv-file');
                
                if (!fileInput.files || fileInput.files.length === 0) {
                    statusDiv.textContent = '请选择CSV文件';
                    statusDiv.className = 'mt-3 text-sm text-red-700';
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                    return;
                }
                
                const formData = new FormData();
                formData.append('csvFile', fileInput.files[0]);
                formData.append('categoryId', categoryId);
                formData.append('isNewCategory', 'false'); // 使用现有分类
                
                fetch('/api/import-csv', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || '导入失败');
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    statusDiv.textContent = `成功导入${result.wordCount}个单词`;
                    statusDiv.className = 'mt-3 text-sm text-green-700';
                    
                    // 重新加载单词列表
                    currentPage = 1; // 重置到第一页
                    loadWordsWithPagination(categoryId, currentPage, pageSize);
                    
                    // 3秒后自动关闭模态框
                    setTimeout(() => {
                        document.getElementById('import-words-modal').classList.add('hidden');
                    }, 3000);
                })
                .catch(error => {
                    statusDiv.textContent = `错误: ${error.message}`;
                    statusDiv.className = 'mt-3 text-sm text-red-700';
                })
                .finally(() => {
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                });
            } else {
                // 文本框导入
                const textInput = document.getElementById('import-text').value.trim();
                
                if (!textInput) {
                    statusDiv.textContent = '请输入单词数据';
                    statusDiv.className = 'mt-3 text-sm text-red-700';
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                    return;
                }
                
                // 将文本转换为CSV格式
                const lines = textInput.split('\n').filter(line => line.trim());
                
                if (lines.length === 0) {
                    statusDiv.textContent = '没有有效的单词数据';
                    statusDiv.className = 'mt-3 text-sm text-red-700';
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                    return;
                }
                
                // 创建一个Blob对象，模拟CSV文件
                const csvContent = lines.join('\n');
                const csvBlob = new Blob([csvContent], { type: 'text/csv' });
                const csvFile = new File([csvBlob], 'imported_words.csv', { type: 'text/csv' });
                
                const formData = new FormData();
                formData.append('csvFile', csvFile);
                formData.append('categoryId', categoryId);
                formData.append('isNewCategory', 'false'); // 使用现有分类
                
                fetch('/api/import-csv', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        return response.text().then(text => {
                            throw new Error(text || '导入失败');
                        });
                    }
                    return response.json();
                })
                .then(result => {
                    statusDiv.textContent = `成功导入${result.wordCount}个单词`;
                    statusDiv.className = 'mt-3 text-sm text-green-700';
                    
                    // 重新加载单词列表
                    currentPage = 1; // 重置到第一页
                    loadWordsWithPagination(categoryId, currentPage, pageSize);
                    
                    // 3秒后自动关闭模态框
                    setTimeout(() => {
                        document.getElementById('import-words-modal').classList.add('hidden');
                    }, 3000);
                })
                .catch(error => {
                    statusDiv.textContent = `错误: ${error.message}`;
                    statusDiv.className = 'mt-3 text-sm text-red-700';
                })
                .finally(() => {
                    importBtn.textContent = originalText;
                    importBtn.disabled = false;
                });
            }
        }
        
        // 获取分类名称的全局函数
        function getCategoryName(categoryId) {
            if (!categoryId) return '';
            
            try {
                if (!window.categories || !Array.isArray(window.categories)) {
                    return categoryId;
                }
                
                const category = window.categories.find(c => c && c.id === categoryId);
                return category && category.name ? category.name : categoryId;
            } catch (error) {
                console.error('获取分类名称失败:', error);
                return categoryId || '';
            }
        }
    </script>
</body>
</html> 