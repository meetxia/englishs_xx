# 新技术方案安装与使用说明

## 🚀 功能概述

已成功集成基于 **Puppeteer + Node.js** 的专业版图片/PDF生成功能到主页下载系统中。

### ✨ 新功能特点

1. **专业模态框界面** - 点击任意卡片的"专业版下载"按钮打开设置界面
2. **多种输出格式** - 支持高清PNG图片和标准PDF文档
3. **灵活尺寸选择** - 自媒体分享、A4打印、正方形等多种画布尺寸
4. **实时预览功能** - 下载前可预览实际效果
5. **服务器端渲染** - 基于Chrome引擎，确保像素完美的输出质量
6. **参数化定制** - 字体大小、背景样式等可调节参数

## 📦 安装依赖

### 1. 安装 Puppeteer

在项目根目录运行以下命令：

```bash
npm install puppeteer
```

> **注意**: Puppeteer 首次安装会下载 Chromium 浏览器（约 200-300MB），请确保网络连接稳定。

### 2. 验证安装

安装完成后，可以通过以下命令验证：

```bash
node -e "console.log('Puppeteer版本:', require('puppeteer/package.json').version)"
```

## 🔧 使用方法

### 1. 启动项目

```bash
npm start
# 或者开发模式
npm run dev
```

### 2. 使用新的下载功能

1. 生成学习卡片内容
2. 点击任意卡片下方的 **"专业版下载"** 按钮
3. 在弹出的模态框中设置参数：
   - 选择生成模式（爽文带背、中英对照等）
   - 选择输出格式（PNG图片或PDF文档）
   - 设置画布尺寸
   - 调整字体大小
   - 选择背景样式
4. 点击 **"生成预览"** 查看效果
5. 满意后点击 **"下载完整版"** 获取高质量文件

## 🎨 输出质量对比

| 功能 | 原版下载 | 专业版下载 |
|------|----------|------------|
| 渲染引擎 | html2canvas | Chrome/Puppeteer |
| 图片质量 | 普通 | 高清(2倍分辨率) |
| 字体渲染 | 可能模糊 | 像素完美 |
| PDF支持 | ❌ | ✅ |
| 预览功能 | ❌ | ✅ |
| 参数设置 | ❌ | ✅ |
| 多种尺寸 | ❌ | ✅ |

## 🛠️ 系统要求

- **Node.js**: v16.x 或更高版本
- **内存**: 至少 2GB 可用内存
- **存储**: 额外 500MB 空间（用于 Chromium）
- **网络**: 首次安装需要稳定的网络连接

## ⚙️ 配置选项

### 画布尺寸选项

- **自媒体分享 (3:4)**: 1200×1600px - 适合社交媒体
- **横屏分享 (16:9)**: 1920×1080px - 适合横屏显示
- **A4打印 (纵向)**: 794×1123px - 标准打印尺寸
- **A4打印 (横向)**: 1123×794px - 横向打印布局
- **正方形 (1:1)**: 1200×1200px - 方形设计

### 输出格式

- **PNG图片**: 高清无损图片，适合在线分享
- **PDF文档**: 矢量文档，适合打印和存档

## 🔍 故障排除

### 常见问题

1. **Puppeteer 安装失败**
   ```bash
   # 设置国内镜像
   npm config set puppeteer_download_host=https://storage.googleapis.com.cnpmjs.org
   npm install puppeteer
   ```

2. **Linux 系统缺少依赖**
   ```bash
   # Ubuntu/Debian
   sudo apt-get install -y libx11-xcb1 libxcomposite1 libxrandr2 libxss1 libxtst6 libgtk-3-0 libasound2

   # CentOS/RHEL
   sudo yum install -y libX11-xcb libXcomposite libXrandr2 libXss libXtst6 gtk3 alsa-lib
   ```

3. **内存不足错误**
   - 确保服务器有足够的可用内存
   - 考虑增加 Node.js 内存限制：
   ```bash
   node --max-old-space-size=4096 server.js
   ```

4. **生成速度慢**
   - 这是正常现象，服务器端渲染需要更多时间
   - 可以考虑实现缓存机制来提升重复生成的速度

## 📊 性能优化建议

1. **生产环境部署**
   - 使用 PM2 等进程管理器
   - 配置适当的内存限制
   - 实现请求队列避免并发过载

2. **缓存策略**
   - 可以考虑对相同内容实现缓存
   - 使用 Redis 存储生成结果

3. **资源监控**
   - 监控内存使用情况
   - 定期重启 Puppeteer 实例释放内存

## 📝 更新日志

### v3.0 (当前版本)
- ✅ 集成 Puppeteer 专业版下载功能
- ✅ 新增模态框参数设置界面
- ✅ 支持实时预览功能
- ✅ 支持多种输出格式和尺寸
- ✅ 切换默认AI模型为 DeepSeek-V3
- ✅ 移除不稳定的 HTML2IMG 功能

### 未来计划
- 🔄 缓存机制优化
- 🔄 批量下载功能
- 🔄 更多模板样式
- 🔄 水印和署名功能

## 🆘 支持

如遇到问题，请检查：
1. Node.js 版本是否满足要求
2. Puppeteer 是否正确安装
3. 系统依赖是否完整
4. 内存是否充足

技术支持联系方式：
- 查看控制台日志获取详细错误信息
- 检查网络连接和防火墙设置