<!-- Generated by SpecStory -->

# 创建项目后端和服务器 (2025-07-27 18:03:45)

_**User**_

帮我把我的项目创建一个后端 用于连接数据库以及前端页面的 还有开启服务器的 让页面可以运行的 

---

_**Assistant**_



---

我将帮你创建一个完整的后端解决方案，用于连接数据库、提供API接口并启动服务器。根据你的项目结构，我会使用Node.js和Express框架来实现这个后端。

---

```diff
- 
+ {
+   "name": "englishs_xx",
+   "version": "1.0.0",
+   "description": "英语学习项目",
+   "main": "server.js",
+   "scripts": {
+     "start": "node server.js",
+     "dev": "nodemon server.js"
+   },
+   "dependencies": {
+     "express": "^4.18.2",
+     "sqlite3": "^5.1.6",
+     "cors": "^2.8.5",
+     "morgan": "^1.10.0"
+   },
+   "devDependencies": {
+     "nodemon": "^3.0.1"
+   }
+ } 
```

---

现在创建主服务器文件：

---

```diff
- 
+ const express = require('express');
+ const path = require('path');
+ const cors = require('cors');
+ const morgan = require('morgan');
+ const dbModule = require('./db');
+ 
+ // 创建Express应用
+ const app = express();
+ const PORT = process.env.PORT || 3000;
+ 
+ // 中间件
+ app.use(cors());                          // 启用CORS
+ app.use(morgan('dev'));                   // 日志记录
+ app.use(express.json());                  // 解析JSON请求体
+ app.use(express.urlencoded({ extended: true })); // 解析表单数据
+ 
+ // 静态文件服务
+ app.use(express.static(path.join(__dirname, 'public')));
+ 
+ // 数据库初始化
+ dbModule.initDb();
+ 
+ // API路由
+ app.use('/api', require('./routes/api'));
+ 
+ // 所有其他请求都返回index.html (SPA支持)
+ app.get('*', (req, res) => {
+   res.sendFile(path.join(__dirname, 'public', 'index.html'));
+ });
+ 
+ // 启动服务器
+ app.listen(PORT, () => {
+   console.log(`服务器已启动，访问地址: http://localhost:${PORT}`);
+ }); 
```

---

接下来创建数据库连接模块：

---

```diff
- 
+ const sqlite3 = require('sqlite3').verbose();
+ const path = require('path');
+ 
+ // 数据库路径
+ const dbPath = path.join(__dirname, 'data', 'words.db');
+ 
+ // 数据库连接实例
+ let db = null;
+ 
+ /**
+  * 初始化数据库连接
+  */
+ function initDb() {
+   return new Promise((resolve, reject) => {
+     if (db) {
+       console.log('数据库已连接');
+       return resolve(db);
+     }
+     
+     console.log(`连接数据库: ${dbPath}`);
+     db = new sqlite3.Database(dbPath, (err) => {
+       if (err) {
+         console.error('数据库连接失败:', err.message);
+         reject(err);
+         return;
+       }
+       
+       console.log('数据库连接成功');
+       resolve(db);
+     });
+   });
+ }
+ 
+ /**
+  * 运行SQL查询（不返回结果）
+  */
+ function run(sql, params = []) {
+   return new Promise((resolve, reject) => {
+     if (!db) {
+       reject(new Error('数据库未连接'));
+       return;
+     }
+     
+     db.run(sql, params, function(err) {
+       if (err) {
+         console.error('SQL执行错误:', err.message);
+         reject(err);
+         return;
+       }
+       
+       resolve({ id: this.lastID, changes: this.changes });
+     });
+   });
+ }
+ 
+ /**
+  * 运行SQL查询（返回单行结果）
+  */
+ function get(sql, params = []) {
+   return new Promise((resolve, reject) => {
+     if (!db) {
+       reject(new Error('数据库未连接'));
+       return;
+     }
+     
+     db.get(sql, params, (err, row) => {
+       if (err) {
+         console.error('SQL执行错误:', err.message);
+         reject(err);
+         return;
+       }
+       
+       resolve(row);
+     });
+   });
+ }
+ 
+ /**
+  * 运行SQL查询（返回多行结果）
+  */
+ function all(sql, params = []) {
+   return new Promise((resolve, reject) => {
+     if (!db) {
+       reject(new Error('数据库未连接'));
+       return;
+     }
+     
+     db.all(sql, params, (err, rows) => {
+       if (err) {
+         console.error('SQL执行错误:', err.message);
+         reject(err);
+         return;
+       }
+       
+       resolve(rows);
+     });
+   });
+ }
+ 
+ /**
+  * 关闭数据库连接
+  */
+ function closeDb() {
+   return new Promise((resolve, reject) => {
+     if (!db) {
+       console.log('数据库未连接');
+       return resolve();
+     }
+     
+     db.close((err) => {
+       if (err) {
+         console.error('关闭数据库错误:', err.message);
+         reject(err);
+         return;
+       }
+       
+       console.log('数据库已关闭');
+       db = null;
+       resolve();
+     });
+   });
+ }
+ 
+ module.exports = {
+   initDb,
+   run,
+   get,
+   all,
+   closeDb
+ }; 
```

---

现在创建API路由文件：

---

```bash
mkdir -p routes
```

```
PS H:\momo-ruanjiansheji\englishs_xx> mkdir -p routes


    目录: H:\momo-ruanjiansheji\englishs_xx


Mode                 LastWriteTime         Length Name
----                 -------------         ------ ----
d-----         2025/7/27     18:14                routes


PS H:\momo-ruanjiansheji\englishs_xx>
```

---

```diff
- 
+ const express = require('express');
+ const router = express.Router();
+ const db = require('../db');
+ 
+ /**
+  * 获取所有单词
+  */
+ router.get('/words', async (req, res) => {
+   try {
+     const words = await db.all('SELECT * FROM words');
+     res.json(words);
+   } catch (err) {
+     console.error('获取单词列表失败:', err);
+     res.status(500).json({ error: '获取单词列表失败', details: err.message });
+   }
+ });
+ 
+ /**
+  * 获取单个单词
+  */
+ router.get('/words/:id', async (req, res) => {
+   try {
+     const word = await db.get('SELECT * FROM words WHERE id = ?', [req.params.id]);
+     if (!word) {
+       return res.status(404).json({ error: '未找到该单词' });
+     }
+     res.json(word);
+   } catch (err) {
+     console.error('获取单词详情失败:', err);
+     res.status(500).json({ error: '获取单词详情失败', details: err.message });
+   }
+ });
+ 
+ /**
+  * 添加新单词
+  */
+ router.post('/words', async (req, res) => {
+   const { word, meaning, example } = req.body;
+   
+   if (!word || !meaning) {
+     return res.status(400).json({ error: '缺少必要的字段' });
+   }
+   
+   try {
+     const result = await db.run(
+       'INSERT INTO words (word, meaning, example) VALUES (?, ?, ?)',
+       [word, meaning, example || '']
+     );
+     
+     res.status(201).json({
+       id: result.id,
+       message: '单词添加成功'
+     });
+   } catch (err) {
+     console.error('添加单词失败:', err);
+     res.status(500).json({ error: '添加单词失败', details: err.message });
+   }
+ });
+ 
+ /**
+  * 更新单词
+  */
+ router.put('/words/:id', async (req, res) => {
+   const { word, meaning, example } = req.body;
+   const id = req.params.id;
+   
+   if (!word && !meaning && !example) {
+     return res.status(400).json({ error: '没有提供要更新的字段' });
+   }
+   
+   try {
+     // 先检查单词是否存在
+     const existingWord = await db.get('SELECT * FROM words WHERE id = ?', [id]);
+     if (!existingWord) {
+       return res.status(404).json({ error: '未找到该单词' });
+     }
+     
+     // 更新单词信息
+     const result = await db.run(
+       'UPDATE words SET word = ?, meaning = ?, example = ? WHERE id = ?',
+       [
+         word || existingWord.word,
+         meaning || existingWord.meaning,
+         example !== undefined ? example : existingWord.example,
+         id
+       ]
+     );
+     
+     if (result.changes === 0) {
+       return res.status(404).json({ error: '未找到该单词或未做任何更改' });
+     }
+     
+     res.json({
+       message: '单词更新成功',
+       changes: result.changes
+     });
+   } catch (err) {
+     console.error('更新单词失败:', err);
+     res.status(500).json({ error: '更新单词失败', details: err.message });
+   }
+ });
+ 
+ /**
+  * 删除单词
+  */
+ router.delete('/words/:id', async (req, res) => {
+   const id = req.params.id;
+   
+   try {
+     const result = await db.run('DELETE FROM words WHERE id = ?', [id]);
+     
+     if (result.changes === 0) {
+       return res.status(404).json({ error: '未找到该单词' });
+     }
+     
+     res.json({
+       message: '单词删除成功',
+       changes: result.changes
+     });
+   } catch (err) {
+     console.error('删除单词失败:', err);
+     res.status(500).json({ error: '删除单词失败', details: err.message });
+   }
+ });
+ 
+ /**
+  * 搜索单词
+  */
+ router.get('/search', async (req, res) => {
+   const { q } = req.query;
+   
+   if (!q) {
+     return res.status(400).json({ error: '请提供搜索关键词' });
+   }
+   
+   try {
+     const words = await db.all(
+       'SELECT * FROM words WHERE word LIKE ? OR meaning LIKE ?',
+       [`%${q}%`, `%${q}%`]
+     );
+     
+     res.json(words);
+   } catch (err) {
+     console.error('搜索单词失败:', err);
+     res.status(500).json({ error: '搜索单词失败', details: err.message });
+   }
+ });
+ 
+ module.exports = router; 
```

---

最后，创建一个修改记录文件：

---

```diff
- 
+ # 修改记录
+ 
+ ## 2025-07-27
+ 
+ ### 后端服务器搭建
+ 
+ 1. 创建了 `package.json` 文件，定义了项目依赖：
+    - express: Web应用框架
+    - sqlite3: SQLite数据库驱动
+    - cors: 跨域资源共享
+    - morgan: HTTP请求日志记录器
+    - nodemon: 开发环境下的自动重启工具
+ 
+ 2. 创建了 `server.js` 主服务器文件：
+    - 配置了Express应用和中间件
+    - 设置了静态文件服务
+    - 配置了API路由
+    - 实现了服务器启动功能
+ 
+ 3. 创建了 `db.js` 数据库连接模块：
+    - 实现了与SQLite数据库的连接
+    - 封装了SQL查询功能（run, get, all）
+    - 实现了数据库初始化和关闭功能
+ 
+ 4. 创建了 `routes/api.js` API路由文件：
+    - 实现了单词的CRUD操作API
+    - 添加了单词搜索功能
+    - 统一了错误处理和响应格式
+ 
+ ### 使用说明
+ 
+ 1. 安装依赖：
+    ```
+    npm install
+    ```
+ 
+ 2. 启动服务器：
+    ```
+    npm start
+    ```
+ 
+ 3. 开发模式（自动重启）：
+    ```
+    npm run dev
+    ```
+ 
+ 4. 服务器默认在 http://localhost:3000 运行 
```

---

我已经帮你完成了后端服务器的创建。以下是我创建的主要文件和功能：

1. **package.json**：定义了项目依赖，包括Express（Web框架）、SQLite3（数据库驱动）、CORS（跨域资源共享）和Morgan（日志记录）等。

2. **server.js**：主服务器文件，配置了Express应用、中间件、静态文件服务和API路由。

3. **db.js**：数据库连接模块，提供了与SQLite数据库交互的函数，包括连接数据库、执行查询等。

4. **routes/api.js**：API路由文件，实现了对单词的增删改查操作，以及搜索功能。

5. **修改记录.md**：记录了所有修改内容和使用说明。

要运行这个后端服务器，你需要按照以下步骤操作：

1. 安装依赖：
   ```
   npm install
   ```

2. 启动服务器：
   ```
   npm start
   ```

或者在开发模式下运行（自动重启）：
   ```
   npm run dev
   ```

服务器会在 http://localhost:3000 上运行，前端页面可以通过 API 接口与数据库交互。API接口包括：
- GET /api/words - 获取所有单词
- GET /api/words/:id - 获取单个单词
- POST /api/words - 添加新单词
- PUT /api/words/:id - 更新单词
- DELETE /api/words/:id - 删除单词
- GET /api/search?q=关键词 - 搜索单词

这个后端架构可以满足你连接数据库和前端页面的需求，同时提供了RESTful API接口供前端调用。

---

_**User**_

请帮我把后台@admin.html 连接上数据库 请你帮我编写js连接上数据库 

---

_**Assistant**_



---

我将帮你创建JavaScript代码，将admin.html连接到我们之前搭建的后端数据库。首先创建一个专用于后台管理的JavaScript文件：

---

Cancelled

---

_**User**_

请分段编辑避免token限制

---

_**Assistant**_



---

我会分段创建admin.js文件，将各个功能模块分开编写，以避免token限制。先创建第一部分，包含基础初始化和仪表盘功能：

---

```diff
- 
+ /**
+  * 爽文带背单词 - 后台管理系统JavaScript
+  * 第一部分：基础初始化和仪表盘功能
+  */
+ 
+ // API基础URL
+ const API_BASE_URL = '/api';
+ 
+ // 基础功能初始化
+ document.addEventListener('DOMContentLoaded', () => {
+     // 侧边栏导航切换
+     const sidebarItems = document.querySelectorAll('.sidebar-item');
+     sidebarItems.forEach(item => {
+         item.addEventListener('click', (e) => {
+             e.preventDefault();
+             
+             // 更新活动状态
+             sidebarItems.forEach(i => i.classList.remove('active'));
+             item.classList.add('active');
+             
+             // 获取目标内容区ID
+             const targetId = item.getAttribute('href').substring(1);
+             const sectionTitle = item.querySelector('span').textContent;
+             
+             // 更新标题
+             document.getElementById('current-section-title').textContent = sectionTitle;
+             
+             // 切换内容区显示
+             document.querySelectorAll('.tab-content').forEach(content => {
+                 content.classList.remove('active');
+             });
+             
+             const targetContent = document.getElementById(`${targetId}-content`);
+             if (targetContent) {
+                 targetContent.classList.add('active');
+                 
+                 // 如果切换到模板管理页面，加载模板数据
+                 if (targetId === 'theme-templates') {
+                     loadTemplates();
+                 }
+                 // 如果切换到单词数据页面，加载分类数据
+                 else if (targetId === 'word-data') {
+                     loadCategories();
+                 }
+                 // 如果切换到数据导入页面，也加载分类数据
+                 else if (targetId === 'import-data') {
+                     loadCategoriesForImport();
+                 }
+             }
+         });
+     });
+     
+     // 加载仪表盘数据
+     loadDashboardData();
+     
+     // 绑定模板管理相关事件
+     initTemplateEvents();
+     
+     // 绑定单词管理相关事件
+     initWordEvents();
+     
+     // 绑定数据导入相关事件
+     initImportEvents();
+ });
+ 
+ // 通用错误处理函数
+ function handleError(error, defaultMessage = '操作失败') {
+     console.error(error);
+     let errorMessage = defaultMessage;
+     
+     if (error.message) {
+         errorMessage = error.message;
+     } else if (typeof error === 'string') {
+         errorMessage = error;
+     }
+     
+     alert(errorMessage);
+ }
+ 
+ // 加载仪表盘数据
+ async function loadDashboardData() {
+     try {
+         // 检查API状态
+         try {
+             const apiResponse = await fetch(`${API_BASE_URL}/health`);
+             if (apiResponse.ok) {
+                 document.getElementById('api-status').textContent = '正常';
+                 document.getElementById('api-status').classList.add('text-green-600');
+             } else {
+                 document.getElementById('api-status').textContent = '异常';
+                 document.getElementById('api-status').classList.add('text-red-600');
+             }
+         } catch (error) {
+             console.error('API状态检查失败:', error);
+             document.getElementById('api-status').textContent = '异常';
+             document.getElementById('api-status').classList.add('text-red-600');
+         }
+         
+         // 加载分类数据
+         try {
+             const categoriesResponse = await fetch(`${API_BASE_URL}/words/categories`);
+             if (categoriesResponse.ok) {
+                 const categories = await categoriesResponse.json();
+                 document.getElementById('total-categories-count').textContent = categories.length;
+                 document.getElementById('db-status').textContent = '正常';
+                 document.getElementById('db-status').classList.add('text-green-600');
+                 
+                 // 计算所有分类中的单词总数
+                 let totalWords = 0;
+                 const promises = categories.map(async (category) => {
+                     try {
+                         const wordsResponse = await fetch(`${API_BASE_URL}/words/count/${category.id}`);
+                         if (wordsResponse.ok) {
+                             const data = await wordsResponse.json();
+                             return data.count || 0;
+                         }
+                         return 0;
+                     } catch (error) {
+                         console.error(`获取分类 ${category.id} 的单词数量失败:`, error);
+                         return 0;
+                     }
+                 });
+                 
+                 const counts = await Promise.all(promises);
+                 totalWords = counts.reduce((sum, count) => sum + count, 0);
+                 document.getElementById('total-words-count').textContent = totalWords;
+             } else {
+                 document.getElementById('total-categories-count').textContent = '加载失败';
+                 document.getElementById('db-status').textContent = '异常';
+                 document.getElementById('db-status').classList.add('text-red-600');
+             }
+         } catch (error) {
+             console.error('加载分类数据失败:', error);
+             document.getElementById('total-categories-count').textContent = '加载失败';
+             document.getElementById('db-status').textContent = '异常';
+             document.getElementById('db-status').classList.add('text-red-600');
+         }
+         
+         // 加载模板数据
+         try {
+             const templatesResponse = await fetch(`${API_BASE_URL}/theme-templates`);
+             if (templatesResponse.ok) {
+                 const templates = await templatesResponse.json();
+                 document.getElementById('total-templates-count').textContent = templates.length;
+             } else {
+                 document.getElementById('total-templates-count').textContent = '加载失败';
+             }
+         } catch (error) {
+             console.error('加载模板数据失败:', error);
+             document.getElementById('total-templates-count').textContent = '加载失败';
+         }
+         
+     } catch (error) {
+         console.error('加载仪表盘数据失败:', error);
+         document.getElementById('api-status').textContent = '异常';
+         document.getElementById('api-status').classList.add('text-red-600');
+         document.getElementById('db-status').textContent = '异常';
+         document.getElementById('db-status').classList.add('text-red-600');
+     }
+ } 
```

---

现在创建第二部分，用于处理分类管理相关功能：

---

```diff
- 
+ /**
+  * 爽文带背单词 - 后台管理系统JavaScript
+  * 第二部分：分类管理功能
+  */
+ 
+ // 全局变量
+ window.categories = [];
+ 
+ // 加载分类数据
+ async function loadCategories() {
+     try {
+         const response = await fetch(`${API_BASE_URL}/words/categories`);
+         if (!response.ok) {
+             throw new Error(`加载分类失败: ${response.status}`);
+         }
+         
+         const categories = await response.json();
+         // 确保categories是数组
+         if (!Array.isArray(categories)) {
+             console.error('加载分类失败: 返回数据不是数组');
+             document.getElementById('categories-table-body').innerHTML = 
+                 '<tr><td colspan="4" class="py-4 text-center text-red-500">加载失败: 数据格式错误</td></tr>';
+             return;
+         }
+         
+         window.categories = categories; // 存储到全局变量
+         
+         // 更新分类表格
+         const tableBody = document.getElementById('categories-table-body');
+         if (categories.length === 0) {
+             tableBody.innerHTML = '<tr><td colspan="4" class="py-4 text-center text-gray-500">暂无数据</td></tr>';
+             return;
+         }
+         
+         let html = '';
+         categories.forEach(category => {
+             if (!category || !category.id) return; // 跳过无效数据
+             
+             const safeId = category.id.replace(/'/g, "\\'"); // 转义单引号
+             html += `
+                 <tr>
+                     <td class="py-2 px-4 border-b">${category.id}</td>
+                     <td class="py-2 px-4 border-b">${category.name || ''}</td>
+                     <td class="py-2 px-4 border-b">${category.description || ''}</td>
+                     <td class="py-2 px-4 border-b">
+                         <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="viewWords('${safeId}')">查看单词</button>
+                         <button class="text-green-500 hover:text-green-700 mr-2" onclick="editCategory('${safeId}')">编辑</button>
+                         <button class="text-red-500 hover:text-red-700" onclick="deleteCategory('${safeId}')">删除</button>
+                     </td>
+                 </tr>
+             `;
+         });
+         tableBody.innerHTML = html;
+         
+         // 更新分类下拉框
+         updateCategoryDropdowns(categories);
+         
+     } catch (error) {
+         console.error('加载分类失败:', error);
+         document.getElementById('categories-table-body').innerHTML = 
+             '<tr><td colspan="4" class="py-4 text-center text-red-500">加载失败</td></tr>';
+         handleError(error, '加载分类失败');
+     }
+ }
+ 
+ // 加载分类数据（用于导入页面）
+ async function loadCategoriesForImport() {
+     try {
+         const response = await fetch(`${API_BASE_URL}/words/categories`);
+         if (!response.ok) {
+             throw new Error(`加载分类失败: ${response.status}`);
+         }
+         
+         const categories = await response.json();
+         
+         // 更新分类下拉框
+         const categorySelect = document.getElementById('category-select');
+         
+         // 清空现有选项，但保留第一个
+         while (categorySelect.options.length > 1) {
+             categorySelect.remove(1);
+         }
+         
+         // 添加新选项
+         categories.forEach(category => {
+             const option = new Option(category.name, category.id);
+             categorySelect.add(option);
+         });
+         
+     } catch (error) {
+         console.error('加载分类失败:', error);
+         handleError(error, '加载分类失败');
+     }
+ }
+ 
+ // 更新分类下拉框
+ function updateCategoryDropdowns(data) {
+     if (!Array.isArray(data)) {
+         console.error('更新分类下拉框失败: 数据不是数组');
+         return;
+     }
+     
+     const categoryFilter = document.getElementById('category-filter');
+     const wordCategory = document.getElementById('word-category');
+     
+     if (!categoryFilter || !wordCategory) {
+         console.error('更新分类下拉框失败: 找不到下拉框元素');
+         return;
+     }
+     
+     // 清空现有选项，但保留第一个
+     while (categoryFilter.options.length > 1) {
+         categoryFilter.remove(1);
+     }
+     
+     while (wordCategory.options.length > 1) {
+         wordCategory.remove(1);
+     }
+     
+     // 添加新选项
+     data.forEach(category => {
+         if (!category || !category.id || !category.name) return; // 跳过无效数据
+         
+         try {
+             const option1 = new Option(category.name, category.id);
+             const option2 = new Option(category.name, category.id);
+             categoryFilter.add(option1);
+             wordCategory.add(option2);
+         } catch (error) {
+             console.error(`添加分类选项失败: ${category.id}`, error);
+         }
+     });
+ }
+ 
+ // 查看分类下的单词
+ function viewWords(categoryId) {
+     // 切换到单词管理标签
+     document.querySelector('.sidebar-item[href="#word-data"]').click();
+     
+     // 设置分类筛选器
+     document.getElementById('category-filter').value = categoryId;
+     
+     // 触发change事件
+     const event = new Event('change');
+     document.getElementById('category-filter').dispatchEvent(event);
+ }
+ 
+ // 编辑分类
+ function editCategory(id) {
+     // 查找分类数据
+     const category = window.categories.find(c => c.id === id);
+     if (!category) {
+         alert('找不到该分类');
+         return;
+     }
+     
+     // 填充表单
+     document.getElementById('category-id').value = category.id;
+     document.getElementById('category-name').value = category.name;
+     document.getElementById('category-description').value = category.description || '';
+     
+     // 添加一个隐藏字段来存储原始ID
+     let editIdField = document.getElementById('category-edit-id');
+     if (!editIdField) {
+         editIdField = document.createElement('input');
+         editIdField.type = 'hidden';
+         editIdField.id = 'category-edit-id';
+         document.getElementById('category-form').appendChild(editIdField);
+     }
+     editIdField.value = id;
+     
+     // 修改模态框标题
+     document.querySelector('#category-modal h3').textContent = '编辑分类';
+     
+     // 显示模态框
+     document.getElementById('category-modal').classList.remove('hidden');
+ }
+ 
+ // 保存分类
+ async function saveCategory(e) {
+     e.preventDefault();
+     
+     const id = document.getElementById('category-id').value.trim();
+     const name = document.getElementById('category-name').value.trim();
+     const description = document.getElementById('category-description').value.trim();
+     const editId = document.getElementById('category-edit-id') ? document.getElementById('category-edit-id').value : null;
+     
+     if (!id || !name) {
+         alert('ID和名称为必填项');
+         return;
+     }
+     
+     let url = `${API_BASE_URL}/words/categories`;
+     let method = 'POST';
+     
+     // 如果是编辑模式
+     if (editId) {
+         url = `${API_BASE_URL}/words/categories/${editId}`;
+         method = 'PUT';
+     }
+     
+     try {
+         const response = await fetch(url, {
+             method,
+             headers: {
+                 'Content-Type': 'application/json'
+             },
+             body: JSON.stringify({ id, name, description })
+         });
+         
+         if (!response.ok) {
+             const errorData = await response.json().catch(() => ({}));
+             throw new Error(errorData.message || `保存失败: ${response.status}`);
+         }
+         
+         document.getElementById('category-modal').classList.add('hidden');
+         loadCategories();
+     } catch (error) {
+         handleError(error, '保存分类失败');
+     }
+ }
+ 
+ // 删除分类
+ async function deleteCategory(id) {
+     if (!confirm(`确定要删除分类 "${id}" 吗？`)) {
+         return;
+     }
+     
+     try {
+         const response = await fetch(`${API_BASE_URL}/words/categories/${id}`, {
+             method: 'DELETE'
+         });
+         
+         if (!response.ok) {
+             const errorData = await response.json().catch(() => ({}));
+             throw new Error(errorData.message || `删除失败: ${response.status}`);
+         }
+         
+         loadCategories();
+     } catch (error) {
+         handleError(error, '删除分类失败');
+     }
+ }
+ 
+ // 获取分类名称的辅助函数
+ function getCategoryName(categoryId) {
+     if (!categoryId) return '';
+     
+     try {
+         if (!window.categories || !Array.isArray(window.categories)) {
+             return categoryId;
+         }
+         
+         const category = window.categories.find(c => c && c.id === categoryId);
+         return category && category.name ? category.name : categoryId;
+     } catch (error) {
+         console.error('获取分类名称失败:', error);
+         return categoryId || '';
+     }
+ } 
```

---

现在创建第三部分，用于单词管理相关功能：

---

Cancelled

---



---

_**User**_

请继续,分段编辑避免token限制

---

_**Assistant**_



---

我将继续创建第三部分，专注于单词管理功能：

---

```diff
- 
+ /**
+  * 爽文带背单词 - 后台管理系统JavaScript
+  * 第三部分：单词管理功能
+  */
+ 
+ // 全局变量
+ let currentPage = 1;
+ let totalPages = 1;
+ let currentCategoryId = '';
+ let pageSize = 100; // 默认每页100条
+ 
+ // 初始化单词管理相关事件
+ function initWordEvents() {
+     // 绑定单词添加按钮事件
+     document.getElementById('add-word-btn').addEventListener('click', () => {
+         // 重置表单
+         document.getElementById('word-form').reset();
+         document.getElementById('word-modal').classList.remove('hidden');
+     });
+ 
+     // 绑定导入单词按钮事件
+     document.getElementById('import-words-btn').addEventListener('click', () => {
+         // 设置导入分类信息
+         const categoryId = document.getElementById('category-filter').value;
+         const categoryName = getCategoryName(categoryId);
+         document.getElementById('import-category').innerHTML = `<option value="${categoryId}">${categoryName}</option>`;
+         
+         // 显示模态框
+         document.getElementById('import-words-modal').classList.remove('hidden');
+     });
+ 
+     // 绑定清理重复单词按钮事件
+     document.getElementById('clean-duplicates-btn').addEventListener('click', cleanDuplicateWords);
+ 
+     // 绑定清空分类单词按钮事件
+     document.getElementById('clear-category-btn').addEventListener('click', clearCategoryWords);
+ 
+     // 绑定批量删除按钮事件
+     document.getElementById('batch-delete-btn').addEventListener('click', batchDeleteWords);
+ 
+     // 绑定分类筛选器变更事件
+     document.getElementById('category-filter').addEventListener('change', (e) => {
+         const categoryId = e.target.value;
+         currentCategoryId = categoryId;
+         if (categoryId) {
+             // 重置为第一页
+             currentPage = 1;
+             document.getElementById('page-input').value = 1;
+             
+             // 加载单词（带分页）
+             loadWordsWithPagination(categoryId, currentPage, pageSize);
+             
+             // 显示相关按钮
+             document.getElementById('clean-duplicates-btn').classList.remove('hidden');
+             document.getElementById('clear-category-btn').classList.remove('hidden');
+             document.getElementById('batch-delete-btn').classList.remove('hidden');
+             document.getElementById('select-all-words').classList.remove('hidden');
+             document.getElementById('page-size-select').classList.remove('hidden');
+             document.getElementById('pagination-controls').classList.remove('hidden');
+             document.getElementById('import-words-btn').classList.remove('hidden');
+         } else {
+             document.getElementById('words-table-body').innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">请先选择一个词库分类</td></tr>';
+             
+             // 隐藏相关按钮
+             document.getElementById('clean-duplicates-btn').classList.add('hidden');
+             document.getElementById('clear-category-btn').classList.add('hidden');
+             document.getElementById('batch-delete-btn').classList.add('hidden');
+             document.getElementById('select-all-words').classList.add('hidden');
+             document.getElementById('page-size-select').classList.add('hidden');
+             document.getElementById('pagination-controls').classList.add('hidden');
+             document.getElementById('import-words-btn').classList.add('hidden');
+         }
+     });
+ 
+     // 绑定分页控件事件
+     document.getElementById('first-page-btn').addEventListener('click', () => goToPage(1));
+     document.getElementById('prev-page-btn').addEventListener('click', () => goToPage(currentPage - 1));
+     document.getElementById('next-page-btn').addEventListener('click', () => goToPage(currentPage + 1));
+     document.getElementById('last-page-btn').addEventListener('click', () => goToPage(totalPages));
+     document.getElementById('go-page-btn').addEventListener('click', () => {
+         const page = parseInt(document.getElementById('page-input').value);
+         if (page >= 1 && page <= totalPages) {
+             goToPage(page);
+         } else {
+             alert(`请输入1-${totalPages}之间的页码`);
+         }
+     });
+ 
+     // 绑定每页显示数量变更事件
+     document.getElementById('page-size-select').addEventListener('change', (e) => {
+         pageSize = parseInt(e.target.value);
+         currentPage = 1; // 重置到第一页
+         loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
+     });
+ 
+     // 绑定单词表单提交事件
+     document.getElementById('word-form').addEventListener('submit', saveWord);
+ 
+     // 绑定全选/取消全选事件
+     document.getElementById('select-all-words').addEventListener('change', toggleAllWords);
+ }
+ 
+ // 加载单词数据（带分页）
+ async function loadWordsWithPagination(categoryId, page, pageSize) {
+     try {
+         if (!categoryId) {
+             console.error('加载单词失败: 分类ID为空');
+             document.getElementById('words-table-body').innerHTML = 
+                 '<tr><td colspan="7" class="py-4 text-center text-red-500">加载失败: 分类ID为空</td></tr>';
+             return;
+         }
+         
+         const response = await fetch(`${API_BASE_URL}/words/category/${categoryId}/page/${page}?pageSize=${pageSize}`);
+         if (!response.ok) {
+             throw new Error(`加载单词失败: ${response.status}`);
+         }
+         
+         const data = await response.json();
+         const tableBody = document.getElementById('words-table-body');
+         
+         // 验证返回的数据格式
+         if (!data || !data.pagination || !Array.isArray(data.words)) {
+             throw new Error('返回的数据格式不正确');
+         }
+         
+         // 更新分页信息
+         currentPage = data.pagination.currentPage || 1;
+         totalPages = data.pagination.totalPages || 1;
+         
+         document.getElementById('total-words').textContent = data.pagination.total || 0;
+         document.getElementById('current-page').textContent = currentPage;
+         document.getElementById('total-pages').textContent = totalPages;
+         document.getElementById('page-input').value = currentPage;
+         
+         // 更新分页按钮状态
+         document.getElementById('first-page-btn').disabled = currentPage === 1;
+         document.getElementById('prev-page-btn').disabled = currentPage === 1;
+         document.getElementById('next-page-btn').disabled = currentPage === totalPages;
+         document.getElementById('last-page-btn').disabled = currentPage === totalPages;
+         
+         if (data.words.length === 0) {
+             tableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-gray-500">该分类下暂无单词</td></tr>';
+             return;
+         }
+         
+         let html = '';
+         data.words.forEach(word => {
+             if (!word || !word.id || !word.en) return; // 跳过无效数据
+             
+             const categoryName = getCategoryName(word.category_id);
+             const wordId = word.id.toString().replace(/"/g, '&quot;'); // 转义引号
+             
+             html += `
+                 <tr>
+                     <td class="py-2 px-4 border-b">
+                         <input type="checkbox" class="word-checkbox batch-delete-checkbox" data-id="${wordId}">
+                     </td>
+                     <td class="py-2 px-4 border-b">${word.en}</td>
+                     <td class="py-2 px-4 border-b">${word.phonetic || ''}</td>
+                     <td class="py-2 px-4 border-b">${word.pos || ''}</td>
+                     <td class="py-2 px-4 border-b">${word.cn || ''}</td>
+                     <td class="py-2 px-4 border-b">${categoryName || ''}</td>
+                     <td class="py-2 px-4 border-b">
+                         <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="editWord(${wordId})">编辑</button>
+                         <button class="text-red-500 hover:text-red-700" onclick="deleteWord(${wordId})">删除</button>
+                     </td>
+                 </tr>
+             `;
+         });
+         tableBody.innerHTML = html;
+         
+     } catch (error) {
+         console.error('加载单词失败:', error);
+         document.getElementById('words-table-body').innerHTML = 
+             '<tr><td colspan="7" class="py-4 text-center text-red-500">加载失败: ' + error.message + '</td></tr>';
+         handleError(error, '加载单词失败');
+     }
+ } 
```

---

继续创建第四部分，包含单词编辑和删除功能：

---

```diff
- 
+ /**
+  * 爽文带背单词 - 后台管理系统JavaScript
+  * 第四部分：单词编辑和删除功能
+  */
+ 
+ // 跳转到指定页
+ function goToPage(page) {
+     if (page < 1 || page > totalPages || !currentCategoryId) {
+         return;
+     }
+     
+     currentPage = page;
+     document.getElementById('page-input').value = page;
+     loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
+ }
+ 
+ // 全选/取消全选单词
+ function toggleAllWords(e) {
+     const isChecked = e.target.checked;
+     document.querySelectorAll('.word-checkbox').forEach(checkbox => {
+         checkbox.checked = isChecked;
+     });
+ }
+ 
+ // 编辑单词
+ async function editWord(id) {
+     if (!id) {
+         alert('单词ID无效');
+         return;
+     }
+     
+     try {
+         const response = await fetch(`${API_BASE_URL}/words/${id}`);
+         if (!response.ok) {
+             throw new Error(`获取单词数据失败: ${response.status}`);
+         }
+         
+         const word = await response.json();
+         if (!word || !word.id) {
+             throw new Error('获取到的单词数据无效');
+         }
+         
+         document.getElementById('word-id').value = word.id;
+         document.getElementById('word-en').value = word.en || '';
+         document.getElementById('word-phonetic').value = word.phonetic || '';
+         document.getElementById('word-pos').value = word.pos || '';
+         document.getElementById('word-cn').value = word.cn || '';
+         document.getElementById('word-category').value = word.category_id || '';
+         
+         document.getElementById('word-modal').classList.remove('hidden');
+     } catch (error) {
+         console.error('加载单词数据失败:', error);
+         handleError(error, '加载单词数据失败');
+     }
+ }
+ 
+ // 保存单词
+ async function saveWord(e) {
+     e.preventDefault();
+     
+     const id = document.getElementById('word-id').value;
+     const en = document.getElementById('word-en').value.trim();
+     const phonetic = document.getElementById('word-phonetic').value.trim();
+     const pos = document.getElementById('word-pos').value.trim();
+     const cn = document.getElementById('word-cn').value.trim();
+     const category_id = document.getElementById('word-category').value;
+     
+     if (!en || !category_id) {
+         alert('英文单词和所属分类为必填项');
+         return;
+     }
+     
+     const wordData = { en, phonetic, pos, cn, category_id };
+     
+     try {
+         let url = `${API_BASE_URL}/words`;
+         let method = 'POST';
+         
+         if (id) {
+             url = `${API_BASE_URL}/words/${id}`;
+             method = 'PUT';
+         }
+         
+         const response = await fetch(url, {
+             method,
+             headers: {
+                 'Content-Type': 'application/json'
+             },
+             body: JSON.stringify(wordData)
+         });
+         
+         if (!response.ok) {
+             const errorText = await response.text();
+             throw new Error(errorText || `保存失败: ${response.status}`);
+         }
+         
+         document.getElementById('word-modal').classList.add('hidden');
+         
+         // 重新加载当前页
+         if (currentCategoryId) {
+             loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
+         }
+     } catch (error) {
+         console.error('保存单词失败:', error);
+         handleError(error, '保存单词失败');
+     }
+ }
+ 
+ // 删除单词
+ async function deleteWord(id) {
+     if (!id) {
+         alert('单词ID无效');
+         return;
+     }
+     
+     if (!confirm('确定要删除这个单词吗？')) {
+         return;
+     }
+     
+     try {
+         const response = await fetch(`${API_BASE_URL}/words/${id}`, {
+             method: 'DELETE'
+         });
+         
+         if (!response.ok) {
+             const errorText = await response.text();
+             throw new Error(errorText || `删除失败: ${response.status}`);
+         }
+         
+         // 重新加载当前页
+         if (currentCategoryId) {
+             loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
+         }
+     } catch (error) {
+         console.error('删除单词失败:', error);
+         handleError(error, '删除单词失败');
+     }
+ }
+ 
+ // 清理重复单词
+ async function cleanDuplicateWords() {
+     const categoryId = currentCategoryId;
+     
+     if (!categoryId) {
+         alert('请先选择一个词库分类');
+         return;
+     }
+     
+     if (!confirm('确定要清理该分类下的重复单词吗？此操作将保留每个单词的第一个出现，删除其余重复项。')) {
+         return;
+     }
+     
+     try {
+         // 显示加载状态
+         const cleanBtn = document.getElementById('clean-duplicates-btn');
+         const originalText = cleanBtn.innerHTML;
+         cleanBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 清理中...';
+         cleanBtn.disabled = true;
+         
+         const response = await fetch(`${API_BASE_URL}/words/clean-duplicates/${categoryId}`, {
+             method: 'POST'
+         });
+         
+         if (!response.ok) {
+             throw new Error('清理失败');
+         }
+         
+         const result = await response.json();
+         
+         // 恢复按钮状态
+         cleanBtn.innerHTML = originalText;
+         cleanBtn.disabled = false;
+         
+         // 显示结果
+         if (result.deletedCount > 0) {
+             alert(`清理完成！已删除 ${result.deletedCount} 个重复单词。`);
+         } else {
+             alert('没有找到需要清理的重复单词。');
+         }
+         
+         // 重新加载单词列表
+         loadWordsWithPagination(categoryId, currentPage, pageSize);
+     } catch (error) {
+         // 恢复按钮状态
+         const cleanBtn = document.getElementById('clean-duplicates-btn');
+         cleanBtn.innerHTML = '<i class="fas fa-broom mr-1"></i> 清理重复单词';
+         cleanBtn.disabled = false;
+         
+         handleError(error, '清理重复单词失败');
+     }
+ }
+ 
+ // 清空分类单词
+ async function clearCategoryWords() {
+     const categoryId = currentCategoryId;
+     
+     if (!categoryId) {
+         alert('请先选择一个词库分类');
+         return;
+     }
+     
+     const categoryName = getCategoryName(categoryId);
+     if (!confirm(`确定要清空"${categoryName}"分类下的所有单词吗？此操作不可恢复！`)) {
+         return;
+     }
+     
+     // 二次确认
+     if (!confirm('警告：此操作将永久删除该分类下的所有单词数据，确定要继续吗？')) {
+         return;
+     }
+     
+     try {
+         // 显示加载状态
+         const clearBtn = document.getElementById('clear-category-btn');
+         const originalText = clearBtn.innerHTML;
+         clearBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 清空中...';
+         clearBtn.disabled = true;
+         
+         const response = await fetch(`${API_BASE_URL}/words/category/${categoryId}`, {
+             method: 'DELETE'
+         });
+         
+         if (!response.ok) {
+             throw new Error('清空失败');
+         }
+         
+         const result = await response.json();
+         
+         // 恢复按钮状态
+         clearBtn.innerHTML = originalText;
+         clearBtn.disabled = false;
+         
+         // 显示结果
+         alert(`清空成功！已删除 ${result.deletedCount || 0} 个单词。`);
+         
+         // 重置到第一页并重新加载
+         currentPage = 1;
+         document.getElementById('page-input').value = 1;
+         loadWordsWithPagination(categoryId, currentPage, pageSize);
+     } catch (error) {
+         // 恢复按钮状态
+         const clearBtn = document.getElementById('clear-category-btn');
+         clearBtn.innerHTML = '<i class="fas fa-trash-alt mr-1"></i> 清空分类单词';
+         clearBtn.disabled = false;
+         
+         handleError(error, '清空分类单词失败');
+     }
+ }
+ 
+ // 批量删除单词
+ async function batchDeleteWords() {
+     const selectedIds = [];
+     document.querySelectorAll('.word-checkbox:checked').forEach(checkbox => {
+         try {
+             // 尝试将ID转换为整数，如果失败则使用原始字符串
+             const id = checkbox.dataset.id;
+             const parsedId = parseInt(id);
+             selectedIds.push(isNaN(parsedId) ? id : parsedId);
+         } catch (error) {
+             console.error('解析单词ID失败:', error);
+         }
+     });
+     
+     if (selectedIds.length === 0) {
+         alert('请先选择要删除的单词');
+         return;
+     }
+     
+     if (!confirm(`确定要删除选中的 ${selectedIds.length} 个单词吗？`)) {
+         return;
+     }
+     
+     try {
+         // 显示加载状态
+         const batchDeleteBtn = document.getElementById('batch-delete-btn');
+         const originalText = batchDeleteBtn.innerHTML;
+         batchDeleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 删除中...';
+         batchDeleteBtn.disabled = true;
+         
+         const response = await fetch(`${API_BASE_URL}/words/batch`, {
+             method: 'DELETE',
+             headers: {
+                 'Content-Type': 'application/json'
+             },
+             body: JSON.stringify({ ids: selectedIds })
+         });
+         
+         if (!response.ok) {
+             const errorText = await response.text();
+             throw new Error(errorText || `批量删除失败: ${response.status}`);
+         }
+         
+         const result = await response.json();
+         
+         // 恢复按钮状态
+         batchDeleteBtn.innerHTML = originalText;
+         batchDeleteBtn.disabled = false;
+         
+         // 显示结果
+         const deletedCount = result.deletedCount || 0;
+         alert(`删除成功！已删除 ${deletedCount} 个单词。`);
+         
+         // 重新加载当前页
+         loadWordsWithPagination(currentCategoryId, currentPage, pageSize);
+     } catch (error) {
+         // 恢复按钮状态
+         const batchDeleteBtn = document.getElementById('batch-delete-btn');
+         batchDeleteBtn.innerHTML = '<i class="fas fa-trash mr-1"></i> 批量删除';
+         batchDeleteBtn.disabled = false;
+         
+         console.error('批量删除单词失败:', error);
+         handleError(error, '批量删除单词失败');
+     }
+ } 
```

---

现在创建第五部分，包含数据导入和模板管理功能：

---

Cancelled

---



---

_**User**_

请分段编辑，避免token限制！

---

_**Assistant**_



---

我将继续创建第五部分，专注于主题模板管理功能：

---

```diff
- 
+ /**
+  * 爽文带背单词 - 后台管理系统JavaScript
+  * 第五部分：主题模板管理功能
+  */
+ 
+ // 初始化模板管理相关事件
+ function initTemplateEvents() {
+     // 添加模板按钮点击事件
+     document.getElementById('add-template-btn').addEventListener('click', () => {
+         // 重置表单
+         document.getElementById('template-form').reset();
+         document.getElementById('template-id').disabled = false;
+         document.getElementById('template-modal').classList.remove('hidden');
+     });
+     
+     // 导入默认模板按钮点击事件
+     document.getElementById('import-default-templates-btn').addEventListener('click', importDefaultTemplates);
+     
+     // 模板表单提交事件
+     document.getElementById('template-form').addEventListener('submit', saveTemplate);
+     
+     // 模板模态框取消按钮点击事件
+     document.querySelectorAll('.cancel-template-btn').forEach(btn => {
+         btn.addEventListener('click', () => {
+             document.getElementById('template-modal').classList.add('hidden');
+         });
+     });
+ }
+ 
+ // 加载故事主题模板列表
+ async function loadTemplates() {
+     try {
+         const response = await fetch(`${API_BASE_URL}/theme-templates`);
+         if (!response.ok) {
+             throw new Error(`加载模板失败: ${response.status}`);
+         }
+         
+         const templates = await response.json();
+         const tableBody = document.getElementById('templates-table-body');
+         
+         // 确保templates是数组
+         if (!Array.isArray(templates)) {
+             console.error('加载模板失败: 返回数据不是数组');
+             tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-red-500">加载失败: 数据格式错误</td></tr>';
+             return;
+         }
+         
+         if (templates.length === 0) {
+             tableBody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">暂无数据</td></tr>';
+             return;
+         }
+         
+         let html = '';
+         templates.forEach(template => {
+             if (!template || !template.id) return; // 跳过无效数据
+             
+             const status = template.is_active ? 
+                 '<span class="px-2 py-1 bg-green-100 text-green-800 rounded-full text-xs">启用</span>' : 
+                 '<span class="px-2 py-1 bg-gray-100 text-gray-800 rounded-full text-xs">禁用</span>';
+             
+             const safeId = template.id.replace(/'/g, "\\'"); // 转义单引号
+             
+             html += `
+                 <tr>
+                     <td class="py-2 px-4 border-b">${template.id}</td>
+                     <td class="py-2 px-4 border-b">${template.name || ''}</td>
+                     <td class="py-2 px-4 border-b">${template.description || ''}</td>
+                     <td class="py-2 px-4 border-b">${status}</td>
+                     <td class="py-2 px-4 border-b">
+                         <button class="text-blue-500 hover:text-blue-700 mr-2" onclick="viewTemplate('${safeId}')">
+                             <i class="fas fa-eye"></i>
+                         </button>
+                         <button class="text-green-500 hover:text-green-700 mr-2" onclick="editTemplate('${safeId}')">
+                             <i class="fas fa-edit"></i>
+                         </button>
+                         <button class="text-red-500 hover:text-red-700" onclick="deleteTemplate('${safeId}')">
+                             <i class="fas fa-trash"></i>
+                         </button>
+                     </td>
+                 </tr>
+             `;
+         });
+         
+         tableBody.innerHTML = html;
+         
+     } catch (error) {
+         console.error('加载模板失败:', error);
+         document.getElementById('templates-table-body').innerHTML = 
+             '<tr><td colspan="5" class="py-4 text-center text-red-500">加载失败: ' + error.message + '</td></tr>';
+         handleError(error, '加载模板失败');
+     }
+ }
+ 
+ // 查看模板详情
+ async function viewTemplate(id) {
+     try {
+         const response = await fetch(`${API_BASE_URL}/theme-templates/${id}`);
+         if (!response.ok) {
+             throw new Error(`获取模板失败: ${response.status}`);
+         }
+         
+         const template = await response.json();
+         
+         // 填充表单
+         document.getElementById('template-id').value = template.id;
+         document.getElementById('template-id').disabled = true; // 查看模式下不允许修改ID
+         document.getElementById('template-name').value = template.name;
+         document.getElementById('template-description').value = template.description || '';
+         document.getElementById('template-prompt').value = template.prompt_text;
+         document.getElementById('template-active').checked = template.is_active === 1;
+         
+         // 禁用所有输入框
+         document.querySelectorAll('#template-form input, #template-form textarea').forEach(input => {
+             input.disabled = true;
+         });
+         
+         // 隐藏保存按钮，只显示取消按钮
+         document.querySelector('#template-form button[type="submit"]').classList.add('hidden');
+         
+         // 显示模态框
+         document.getElementById('template-modal').classList.remove('hidden');
+         
+     } catch (error) {
+         console.error('查看模板失败:', error);
+         handleError(error, '查看模板失败');
+     }
+ }
+ 
+ // 编辑模板
+ async function editTemplate(id) {
+     try {
+         const response = await fetch(`${API_BASE_URL}/theme-templates/${id}`);
+         if (!response.ok) {
+             throw new Error(`获取模板失败: ${response.status}`);
+         }
+         
+         const template = await response.json();
+         
+         // 填充表单
+         document.getElementById('template-id').value = template.id;
+         document.getElementById('template-id').disabled = true; // 编辑模式下不允许修改ID
+         document.getElementById('template-name').value = template.name;
+         document.getElementById('template-description').value = template.description || '';
+         document.getElementById('template-prompt').value = template.prompt_text;
+         document.getElementById('template-active').checked = template.is_active === 1;
+         
+         // 启用所有输入框
+         document.querySelectorAll('#template-form input, #template-form textarea').forEach(input => {
+             if (input.id !== 'template-id') {
+                 input.disabled = false;
+             }
+         });
+         
+         // 显示保存按钮
+         document.querySelector('#template-form button[type="submit"]').classList.remove('hidden');
+         
+         // 显示模态框
+         document.getElementById('template-modal').classList.remove('hidden');
+         
+     } catch (error) {
+         console.error('编辑模板失败:', error);
+         handleError(error, '编辑模板失败');
+     }
+ } 
```

---

继续创建第六部分，包含模板保存和数据导入功能：

---

```diff
- 
+ /**
+  * 爽文带背单词 - 后台管理系统JavaScript
+  * 第六部分：模板保存和数据导入功能
+  */
+ 
+ // 保存模板
+ async function saveTemplate(e) {
+     e.preventDefault();
+     
+     const id = document.getElementById('template-id').value.trim();
+     const name = document.getElementById('template-name').value.trim();
+     const description = document.getElementById('template-description').value.trim();
+     const prompt_text = document.getElementById('template-prompt').value.trim();
+     const is_active = document.getElementById('template-active').checked ? 1 : 0;
+     
+     if (!id || !name || !prompt_text) {
+         alert('ID、名称和提示词文本为必填项');
+         return;
+     }
+     
+     const templateData = { id, name, description, prompt_text, is_active };
+     const isEdit = document.getElementById('template-id').disabled;
+     
+     try {
+         const url = isEdit ? `${API_BASE_URL}/theme-templates/${id}` : `${API_BASE_URL}/theme-templates`;
+         const method = isEdit ? 'PUT' : 'POST';
+         
+         const response = await fetch(url, {
+             method,
+             headers: { 'Content-Type': 'application/json' },
+             body: JSON.stringify(templateData)
+         });
+         
+         if (!response.ok) {
+             const errorData = await response.json().catch(() => ({}));
+             throw new Error(errorData.error || `保存失败: ${response.status}`);
+         }
+         
+         // 关闭模态框
+         document.getElementById('template-modal').classList.add('hidden');
+         
+         // 重新加载模板列表
+         loadTemplates();
+         
+         // 更新仪表盘数据
+         loadDashboardData();
+         
+     } catch (error) {
+         console.error('保存模板失败:', error);
+         handleError(error, '保存模板失败');
+     }
+ }
+ 
+ // 删除模板
+ async function deleteTemplate(id) {
+     if (!confirm(`确定要删除模板 "${id}" 吗？`)) {
+         return;
+     }
+     
+     try {
+         const response = await fetch(`${API_BASE_URL}/theme-templates/${id}`, {
+             method: 'DELETE'
+         });
+         
+         if (!response.ok) {
+             const errorData = await response.json().catch(() => ({}));
+             throw new Error(errorData.error || `删除失败: ${response.status}`);
+         }
+         
+         // 重新加载模板列表
+         loadTemplates();
+         
+         // 更新仪表盘数据
+         loadDashboardData();
+         
+     } catch (error) {
+         console.error('删除模板失败:', error);
+         handleError(error, '删除模板失败');
+     }
+ }
+ 
+ // 导入默认模板
+ async function importDefaultTemplates() {
+     if (!confirm('确定要导入默认的故事主题模板吗？这将覆盖同名的现有模板。')) {
+         return;
+     }
+     
+     try {
+         // 显示导入中状态
+         const importBtn = document.getElementById('import-default-templates-btn');
+         const originalText = importBtn.innerHTML;
+         importBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> 导入中...';
+         importBtn.disabled = true;
+         
+         const response = await fetch(`${API_BASE_URL}/import-default-templates`, {
+             method: 'POST'
+         });
+         
+         if (!response.ok) {
+             const errorData = await response.json().catch(() => ({}));
+             throw new Error(errorData.error || `导入失败: ${response.status}`);
+         }
+         
+         const result = await response.json();
+         
+         // 恢复按钮状态
+         importBtn.innerHTML = originalText;
+         importBtn.disabled = false;
+         
+         // 显示结果
+         alert(`成功导入 ${result.count || 0} 个默认模板`);
+         
+         // 重新加载模板列表
+         loadTemplates();
+         
+         // 更新仪表盘数据
+         loadDashboardData();
+         
+     } catch (error) {
+         // 恢复按钮状态
+         const importBtn = document.getElementById('import-default-templates-btn');
+         importBtn.innerHTML = '<i class="fas fa-download mr-1"></i> 导入默认模板';
+         importBtn.disabled = false;
+         
+         console.error('导入默认模板失败:', error);
+         handleError(error, '导入默认模板失败');
+     }
+ }
+ 
+ // 初始化数据导入相关事件
+ function initImportEvents() {
+     // 绑定导入按钮事件
+     document.getElementById('import-btn').addEventListener('click', importData);
+     
+     // 绑定CSV上传表单提交事件
+     document.getElementById('csv-upload-form').addEventListener('submit', uploadCSV);
+     
+     // 绑定导入方式切换事件
+     document.querySelectorAll('input[name="import-method"]').forEach(radio => {
+         radio.addEventListener('change', toggleImportMethod);
+     });
+     
+     // 绑定导入提交按钮事件
+     document.getElementById('import-submit-btn').addEventListener('click', submitImport);
+ }
+ 
+ // 从预设文件导入数据
+ async function importData() {
+     const statusDiv = document.getElementById('import-status');
+     statusDiv.textContent = '正在导入...';
+     statusDiv.className = 'mt-3 text-sm text-gray-700';
+ 
+     try {
+         const response = await fetch(`${API_BASE_URL}/import`, {
+             method: 'POST'
+         });
+         
+         if (!response.ok) {
+             throw new Error('导入失败!');
+         }
+         
+         const text = await response.text();
+         
+         statusDiv.textContent = `成功: ${text}`;
+         statusDiv.className = 'mt-3 text-sm text-green-700';
+         
+         // 重新加载分类数据
+         loadCategories();
+         
+         // 更新仪表盘数据
+         loadDashboardData();
+     } catch (error) {
+         statusDiv.textContent = `错误: ${error.message}`;
+         statusDiv.className = 'mt-3 text-sm text-red-700';
+         console.error('导入数据失败:', error);
+     }
+ } 
```

---

最后创建第七部分，包含导入CSV和工具函数：

---

Cancelled

---



---

_**User**_

请继续

---

_**Assistant**_



---

我将继续创建最后一部分，完成CSV导入和剩余的工具函数：

---

```diff
- 
+ /**
+  * 爽文带背单词 - 后台管理系统JavaScript
+  * 第七部分：CSV导入和工具函数
+  */
+ 
+ // 切换导入方式
+ function toggleImportMethod() {
+     const method = document.querySelector('input[name="import-method"]:checked').value;
+     
+     if (method === 'csv') {
+         document.getElementById('csv-import-section').classList.remove('hidden');
+         document.getElementById('text-import-section').classList.add('hidden');
+     } else {
+         document.getElementById('csv-import-section').classList.add('hidden');
+         document.getElementById('text-import-section').classList.remove('hidden');
+     }
+ }
+ 
+ // 上传并导入CSV文件
+ async function uploadCSV(e) {
+     e.preventDefault();
+     
+     const statusDiv = document.getElementById('csv-import-status');
+     const fileInput = document.getElementById('csv-file');
+     const categorySelect = document.getElementById('category-select');
+     const newCategoryId = document.getElementById('new-category-id');
+     const newCategoryName = document.getElementById('new-category-name');
+     
+     // 检查是否选择了文件
+     if (!fileInput.files || fileInput.files.length === 0) {
+         statusDiv.textContent = '请选择CSV文件';
+         statusDiv.className = 'mt-3 text-sm text-red-700';
+         return;
+     }
+     
+     // 检查分类信息
+     let categoryId = categorySelect.value;
+     let isNewCategory = false;
+     
+     if (!categoryId) {
+         // 检查是否提供了新分类信息
+         categoryId = newCategoryId.value.trim();
+         const categoryName = newCategoryName.value.trim();
+         
+         if (!categoryId || !categoryName) {
+             statusDiv.textContent = '请选择现有分类或提供新分类信息';
+             statusDiv.className = 'mt-3 text-sm text-red-700';
+             return;
+         }
+         
+         isNewCategory = true;
+     }
+     
+     // 构建FormData对象
+     const formData = new FormData();
+     formData.append('csvFile', fileInput.files[0]);
+     formData.append('categoryId', categoryId);
+     
+     if (isNewCategory) {
+         formData.append('categoryName', newCategoryName.value.trim());
+         formData.append('isNewCategory', 'true');
+     }
+     
+     // 显示上传中状态
+     statusDiv.textContent = '正在上传并处理CSV文件，请稍候...';
+     statusDiv.className = 'mt-3 text-sm text-gray-700';
+     
+     try {
+         // 发送请求
+         const response = await fetch(`${API_BASE_URL}/import-csv`, {
+             method: 'POST',
+             body: formData
+         });
+         
+         if (!response.ok) {
+             const errorText = await response.text();
+             throw new Error(errorText || '上传CSV失败');
+         }
+         
+         const result = await response.json();
+         
+         statusDiv.textContent = `成功导入${result.wordCount}个单词到"${result.categoryName}"分类`;
+         statusDiv.className = 'mt-3 text-sm text-green-700';
+         
+         // 重置表单
+         fileInput.value = '';
+         
+         // 如果是新分类，重置输入框
+         if (isNewCategory) {
+             newCategoryId.value = '';
+             newCategoryName.value = '';
+         }
+         
+         // 重新加载分类数据
+         loadCategories();
+         
+         // 更新仪表盘数据
+         loadDashboardData();
+     } catch (error) {
+         statusDiv.textContent = `错误: ${error.message}`;
+         statusDiv.className = 'mt-3 text-sm text-red-700';
+         console.error('上传CSV失败:', error);
+     }
+ }
+ 
+ // 提交导入
+ async function submitImport() {
+     const categoryId = document.getElementById('import-category').value;
+     const method = document.querySelector('input[name="import-method"]:checked').value;
+     const statusDiv = document.getElementById('import-status');
+     
+     if (!categoryId) {
+         statusDiv.textContent = '请先选择一个分类';
+         statusDiv.className = 'mt-3 text-sm text-red-700';
+         return;
+     }
+     
+     // 显示加载状态
+     const importBtn = document.getElementById('import-submit-btn');
+     const originalText = importBtn.textContent;
+     importBtn.textContent = '导入中...';
+     importBtn.disabled = true;
+     statusDiv.textContent = '正在处理...';
+     statusDiv.className = 'mt-3 text-sm text-gray-700';
+     
+     try {
+         if (method === 'csv') {
+             // CSV文件导入
+             const fileInput = document.getElementById('import-csv-file');
+             
+             if (!fileInput.files || fileInput.files.length === 0) {
+                 statusDiv.textContent = '请选择CSV文件';
+                 statusDiv.className = 'mt-3 text-sm text-red-700';
+                 importBtn.textContent = originalText;
+                 importBtn.disabled = false;
+                 return;
+             }
+             
+             const formData = new FormData();
+             formData.append('csvFile', fileInput.files[0]);
+             formData.append('categoryId', categoryId);
+             formData.append('isNewCategory', 'false'); // 使用现有分类
+             
+             const response = await fetch(`${API_BASE_URL}/import-csv`, {
+                 method: 'POST',
+                 body: formData
+             });
+             
+             if (!response.ok) {
+                 const errorText = await response.text();
+                 throw new Error(errorText || '导入失败');
+             }
+             
+             const result = await response.json();
+             
+             statusDiv.textContent = `成功导入${result.wordCount}个单词`;
+             statusDiv.className = 'mt-3 text-sm text-green-700';
+             
+             // 重新加载单词列表
+             currentPage = 1; // 重置到第一页
+             loadWordsWithPagination(categoryId, currentPage, pageSize);
+             
+             // 3秒后自动关闭模态框
+             setTimeout(() => {
+                 document.getElementById('import-words-modal').classList.add('hidden');
+             }, 3000);
+             
+         } else {
+             // 文本框导入
+             const textInput = document.getElementById('import-text').value.trim();
+             
+             if (!textInput) {
+                 statusDiv.textContent = '请输入单词数据';
+                 statusDiv.className = 'mt-3 text-sm text-red-700';
+                 importBtn.textContent = originalText;
+                 importBtn.disabled = false;
+                 return;
+             }
+             
+             // 将文本转换为CSV格式
+             const lines = textInput.split('\n').filter(line => line.trim());
+             
+             if (lines.length === 0) {
+                 statusDiv.textContent = '没有有效的单词数据';
+                 statusDiv.className = 'mt-3 text-sm text-red-700';
+                 importBtn.textContent = originalText;
+                 importBtn.disabled = false;
+                 return;
+             }
+             
+             // 创建一个Blob对象，模拟CSV文件
+             const csvContent = lines.join('\n');
+             const csvBlob = new Blob([csvContent], { type: 'text/csv' });
+             const csvFile = new File([csvBlob], 'imported_words.csv', { type: 'text/csv' });
+             
+             const formData = new FormData();
+             formData.append('csvFile', csvFile);
+             formData.append('categoryId', categoryId);
+             formData.append('isNewCategory', 'false'); // 使用现有分类
+             
+             const response = await fetch(`${API_BASE_URL}/import-csv`, {
+                 method: 'POST',
+                 body: formData
+             });
+             
+             if (!response.ok) {
+                 const errorText = await response.text();
+                 throw new Error(errorText || '导入失败');
+             }
+             
+             const result = await response.json();
+             
+             statusDiv.textContent = `成功导入${result.wordCount}个单词`;
+             statusDiv.className = 'mt-3 text-sm text-green-700';
+             
+             // 重新加载单词列表
+             currentPage = 1; // 重置到第一页
+             loadWordsWithPagination(categoryId, currentPage, pageSize);
+             
+             // 3秒后自动关闭模态框
+             setTimeout(() => {
+                 document.getElementById('import-words-modal').classList.add('hidden');
+             }, 3000);
+         }
+     } catch (error) {
+         statusDiv.textContent = `错误: ${error.message}`;
+         statusDiv.className = 'mt-3 text-sm text-red-700';
+         console.error('导入失败:', error);
+     } finally {
+         importBtn.textContent = originalText;
+         importBtn.disabled = false;
+     }
+ }
+ 
+ // 模态框通用事件绑定
+ document.addEventListener('DOMContentLoaded', () => {
+     // 绑定所有通用模态框取消按钮
+     document.querySelectorAll('.cancel-btn').forEach(btn => {
+         btn.addEventListener('click', () => {
+             // 找到最近的模态框并隐藏
+             const modal = btn.closest('[id$="-modal"]');
+             if (modal) {
+                 modal.classList.add('hidden');
+             }
+         });
+     });
+ }); 
```

---

现在创建一个完整的admin.js文件，将所有部分合并在一起：

---

Cancelled

---



---

_**User**_

请继续

---

_**Assistant**_



---



---

